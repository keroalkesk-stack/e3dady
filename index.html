<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متابعة حضور إجتماعات و قداسات مدارس الأحد</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* خط "Inter" هو خط أساسي، لكن يتم استخدام خط افتراضي عربي مناسب */
        body { font-family: 'Tahoma', sans-serif; background-color: #f0f4f8; }
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        /* تصميم زر التأكيد ليناسب أجهزة الموبايل */
        .primary-btn {
            padding: 1rem;
            font-size: 1.125rem;
            transition: all 0.2s;
        }
        .primary-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        /* تخصيص لون الإخلاص (البنفسجي) */
        .bg-custom-purple { background-color: #6B46C1; }
        .text-custom-purple { color: #6B46C1; }
        .border-custom-purple { border-color: #6B46C1; }
        /* تصميم زر تسجيل الخروج */
        .logout-btn { background-color: #EF4444; }
        .logout-btn:hover { background-color: #DC2626; }
        /* لتصميم زر الدخول الكبير في الصفحة الرئيسية */
        .large-home-btn { 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 150px;
            width: 100%;
            border: 2px solid;
            text-align: center;
        }
        /* تصميم زر جوجل المخصص */
        .google-btn {
            background-color: #4285F4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1rem;
            font-size: 1.125rem;
            font-weight: bold;
        }
        .google-btn:hover {
            background-color: #3367D6;
        }
        .google-icon {
            background-color: white;
            padding: 0.5rem;
            border-radius: 9999px; /* rounded-full */
            margin-left: 1rem; /* mr-4 */
        }
    </style>
</head>
<body class="p-4 sm:p-6 min-h-screen flex items-start justify-center">

    <div id="app" class="w-full max-w-4xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">👋🏼 متابعة الحضور</h1>
            <p class="text-gray-600">لتسجيل قداسات واجتماعات مدارس الأحد</p>
            <div id="auth-status-display" class="mt-2 text-sm">
                <span id="user-id-display" class="text-gray-400"></span>
                <button id="logout-button" onclick="handleLogout()" class="hidden px-3 py-1 text-xs text-white logout-btn rounded-full mr-2">تسجيل خروج</button>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading" class="hidden text-center p-8 bg-white rounded-xl card transition duration-300">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-custom-purple border-t-transparent rounded-full mb-3"></div>
            <p class="text-lg font-semibold text-gray-700">جارِ تحميل البيانات...</p>
        </div>

        <!-- Main Content Area -->
        <div id="content" class="space-y-6">
            <!-- Navigation Buttons (Hidden by default, shown when logged in or on public view) -->
            <div id="nav-buttons" class="hidden justify-center space-x-4 space-x-reverse mb-6 flex-wrap gap-2">
                <!-- Buttons will be rendered dynamically based on user role (Admin or Child) -->
            </div>

            <!-- Views will be injected here -->
            <div id="view-content" class="space-y-6">
                <!-- View content (Home, Register, Admin, Profile, etc.) goes here -->
            </div>
        </div>
    </div>

    <!-- Modals (Custom Alerts/Prompts) -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-11/12 max-w-sm card">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-custom-purple"></h3>
            <p id="modal-message" class="mb-6 text-gray-700"></p>
            <div id="modal-body"></div>
            <button onclick="hideModal()" class="w-full primary-btn bg-custom-purple text-white rounded-lg">تم</button>
        </div>
    </div>
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app, db, auth, userId;
        let currentPage = 'home'; // Start on the new home page
        let currentChildId = null; 
        let isFirebaseActive = false;
        let isAdmin = false; // Flag to track admin status (logged in via Google/Password)
        // Removed authStateHandled flag as we rely on explicit sign-in now

        // --- Firebase Setup Handling ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        // --- START: CUSTOM CONFIGURATION FOR GITHUB DEPLOYMENT ---
        const GITHUB_FIREBASE_CONFIG = {
             apiKey: "AIzaSy0ByGubyWvdaIVJETOQF6EMJHWF7mcg", 
             authDomain: "sundayschoolattendance-84656.firebaseapp.com", 
             projectId: "sundayschoolattendance-84656", 
             storageBucket: "sundayschoolattendance-84656.appspot.com",
             messagingSenderId: "444562341363",
             appId: "1:444562341363:web:10ff6f84df01ae599a686"
        };
        
        // إذا لم يتم توفير إعدادات Canvas (أي عند التشغيل خارج Canvas)، استخدم إعدادات GitHub
        if (!firebaseConfig) {
             firebaseConfig = GITHUB_FIREBASE_CONFIG;
        }
        
        // Check if real config is provided and is NOT the placeholder 'YOUR_API_KEY'
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
            isFirebaseActive = true;
        }
        // --- END: CUSTOM CONFIGURATION FOR GITHUB DEPLOYMENT ---

        // Set log level for debugging Firestore (optional but helpful)
        setLogLevel('debug');

        // Utility delay function
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));


        // --- Auth and Initialization ---

        /**
         * Initializes Firebase and ensures the user is signed in (either via Canvas token or anonymously).
         */
        async function initializeAppAndAuth() {
            
            if (!isFirebaseActive) {
                console.warn("Firebase configuration not found. Running in UI simulation mode.");
                document.getElementById('loading').innerHTML = `<p class="text-red-600 font-bold">⚠️ وضع المحاكاة: لا يوجد اتصال بقاعدة البيانات.</p>`;
                
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                    navigate(currentPage);
                }, 500);
                return;
            }

            // --- Real Firebase Initialization ---
            try {
                // 1. Initialize App and Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                let userCredential;

                // 2. Try to sign in with Canvas Auth Token first (MANDATORY for Canvas environment)
                if (initialAuthToken) {
                    try {
                        userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with Custom Token.");
                    } catch (e) {
                        console.warn("Custom token sign-in failed. Falling back to anonymous login.", e);
                        // If custom token fails, proceed to anonymous sign-in
                        userCredential = await signInAnonymously(auth);
                    }
                } else {
                    // 3. If no custom token, sign in anonymously for public access
                    userCredential = await signInAnonymously(auth);
                }

                // 4. Once auth is established (either way), set up the state.
                const user = userCredential.user;
                userId = user.uid;
                
                // Check if the user is an Admin (Google or Email/Password provider)
                const providerData = user.providerData.length > 0 ? user.providerData : [{ providerId: user.isAnonymous ? 'anonymous' : 'custom' }];
                const isGoogleOrEmailAdmin = providerData.some(p => p.providerId === 'google.com' || p.providerId === 'password');
                isAdmin = isGoogleOrEmailAdmin;
                
                document.getElementById('user-id-display').innerText = isAdmin ? `أدمن: ${user.email || 'غير معروف'}` : `مستخدم عام`;
                document.getElementById('logout-button').classList.toggle('hidden', !isAdmin);
                document.getElementById('nav-buttons').classList.remove('hidden');

                // 5. Hide loading and navigate
                document.getElementById('loading').classList.add('hidden');
                
                const params = new URLSearchParams(window.location.search);
                const idFromUrl = params.get('id');
                
                if (idFromUrl) {
                    currentChildId = idFromUrl;
                    navigate('profile'); 
                } else {
                    navigate(currentPage);
                }

            } catch (error) {
                console.error("Critical Firebase Initialization Error:", error);
                 // Display specific error message for critical errors
                document.getElementById('loading').innerHTML = `
                    <p class="text-red-600 font-bold">خطأ في التهيئة الحرجة: ${error.message}</p>
                    <p class="text-sm text-red-500 mt-2">
                        الرجاء التأكد من تفعيل **Anonymous** و **Google** (أو Email/Password) في Firebase > Authentication.
                    </p>
                `;
            }
            
            // Re-setup onAuthStateChanged listener to catch subsequent admin logins/logouts
            onAuthStateChanged(auth, (user) => {
                if (user && user.providerData.length > 0) {
                    const isGoogleOrEmailAdmin = user.providerData.some(p => p.providerId === 'google.com' || p.providerId === 'password');
                    isAdmin = isGoogleOrEmailAdmin;

                    document.getElementById('user-id-display').innerText = isAdmin ? `أدمن: ${user.email}` : `مستخدم عام`;
                    document.getElementById('logout-button').classList.toggle('hidden', !isAdmin);
                    document.getElementById('nav-buttons').classList.remove('hidden');
                    // Force re-render nav bars if we logged in/out
                    if (document.getElementById('nav-buttons').classList.contains('hidden') !== !isAdmin) {
                         // Only re-navigate if the core admin state changed
                         navigate(currentPage);
                    }
                } else if (!user) {
                    // User logged out, ensure we navigate home
                    navigate('home');
                }
            });
        }
        
        /**
         * Handles admin registration (creating a new Khadem account) - NOW VIA GOOGLE.
         */
        window.handleAdminRegister = async function() {
            // We reuse handleGoogleLogin for registration simplicity (Firebase will create the account if it doesn't exist)
            handleGoogleLogin();
        }

        /**
         * Handles Google Sign-in for Admin roles.
         */
        window.handleGoogleLogin = async function() {
            if (!isFirebaseActive) {
                return showModal('⚠️ وضع المحاكاة', 'لا يمكن تسجيل الدخول بدون اتصال بقاعدة بيانات Firebase.');
            }

            const provider = new GoogleAuthProvider();

            // CRITICAL FIX: Sign out the current user (Anonymous/Custom Token user) before signing in with Google
            try {
                // Sign out the current user (Anonymous or Custom Token user)
                await signOut(auth); 
                await delay(500); // Wait briefly for the system to process the logout
            } catch (e) {
                console.warn("Sign out before Google login failed:", e);
            }

            try {
                // 1. Open Google Sign-in Popup
                const userCredential = await signInWithPopup(auth, provider);
                const user = userCredential.user;
                
                // 2. Save Khadem details (or ensure they exist) in Firestore
                const khademDocRef = doc(db, 'khodam', user.uid);
                const khademSnap = await getDoc(khademDocRef);

                if (!khademSnap.exists()) {
                    await setDoc(khademDocRef, {
                        email: user.email,
                        name: user.displayName || 'خادم جديد',
                        createdAt: new Date().toISOString()
                    }, { merge: true });
                    showModal('ترحيب! 🎉', 'تم إنشاء حسابك بنجاح كـ "خادم".');
                } else {
                     showModal('نجاح تسجيل الدخول', 'أهلاً بك! تم تسجيل دخولك كـ "خادم" بنجاح.');
                }
                
                // Auth listener will handle setting isAdmin flag and UI update/navigation
                navigate('admin_scan');

            } catch(error) {
                console.error("Google Login Error:", error);
                 if (error.code === 'auth/popup-closed-by-user') {
                    // User closed the popup, no need for error message
                    return;
                }
                if (error.code === 'auth/unauthorized-domain') {
                    // NEW: Improved message to list required domains
                    const requiredDomains = [
                        'web-app-canvas.web.app',
                        'localhost',
                        'scf.usercontent.goog',
                        'cloudfunctions.net'
                    ].join('<br>');

                    showModal('خطأ في النطاق (Domain)', `
                        فشل تسجيل الدخول عبر Google. هذا يحدث عادةً لأن نطاق تشغيل هذا التطبيق 
                        **غير مصرح به** في إعدادات مشروع Firebase.
                        <br><br>
                        <strong>الرجاء الذهاب إلى Firebase Console -> Authentication -> Settings -> Authorized domains وإضافة النطاقات التالية:</strong>
                        <br><br>
                        <div class="text-left font-mono text-sm bg-gray-100 p-2 rounded">${requiredDomains}</div>
                    `);
                    return;
                }
                showModal('خطأ في الدخول', `حدث خطأ أثناء تسجيل الدخول عبر Google: ${error.message}`);
            }
        }
        
        /**
         * Handles admin logout.
         */
        window.handleLogout = async function() {
            await signOut(auth); // Signs out Google user, which triggers Anonymous sign-in
            isAdmin = false;
            navigate('home');
            showModal('تسجيل الخروج', 'تم تسجيل خروجك بنجاح. يمكنك الآن الدخول كـ "خادم" أو الاستمرار كـ "مخدوم".');
        }


        // --- Utility Functions ---

        /**
         * @returns {string} The collection path for public children data.
         */
        function getChildrenCollectionPath() {
             if (isFirebaseActive && typeof __firebase_config === 'undefined') {
                 return `children`;
             }
             return `artifacts/${appId}/public/data/children`;
        }
        
        /**
         * @param {string} childId The ID of the child document.
         * @returns {string} The collection path for the child's attendance sub-collection.
         */
        function getAttendanceCollectionPath(childId) {
            return `${getChildrenCollectionPath()}/${childId}/attendance`;
        }

        /**
         * @param {Date} date - The date object.
         * @returns {string} Date formatted as 'YYYY-MM-DD' for Firestore Doc ID.
         */
        function formatDateToDocId(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Shows a custom modal dialog (replaces alert()).
         * @param {string} title 
         * @param {string} message 
         * @param {string} bodyHtml 
         */
        window.showModal = function(title, message, bodyHtml = '') {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal-body').innerHTML = bodyHtml;
            document.getElementById('modal-backdrop').classList.remove('hidden');
        }

        /**
         * Hides the custom modal dialog.
         */
        window.hideModal = function() {
            document.getElementById('modal-backdrop').classList.add('hidden');
        }


        // --- Navigation and Rendering ---

        /**
         * Navigates to a new view and updates the UI.
         * @param {string} page - The target view name.
         * @param {string} [childId=null] - Optional child ID for profile/history views.
         */
        window.navigate = function(page, childId = null) {
            currentPage = page;
            currentChildId = childId;
            const content = document.getElementById('view-content'); 
            const navButtons = document.getElementById('nav-buttons');
            
            content.innerHTML = ''; // Clear previous content

            // 1. Decide which navigation buttons to show
            if (page === 'home' || page === 'admin_register' || page === 'admin_login') {
                 navButtons.classList.add('hidden');
            } else if (isAdmin) {
                // Admin Buttons
                navButtons.innerHTML = `
                    <button onclick="navigate('admin_scan')" id="nav-admin" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150">مسح QR</button>
                    <button onclick="navigate('children_list')" id="nav-list" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150">قائمة المخدومين</button>
                    <button onclick="navigate('register')" id="nav-register" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150">تسجيل مخدوم جديد</button>
                `;
                navButtons.classList.remove('hidden', 'justify-center');
                navButtons.classList.add('flex', 'justify-between', 'sm:justify-center'); // Ensure good layout
            } else { 
                // Public access (Makhdoum/Child)
                navButtons.innerHTML = `
                    <button onclick="navigate('register')" id="nav-register" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150">تسجيل جديد</button>
                    <button onclick="navigate('history_search')" id="nav-history" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150">عرض سجل الحضور</button>
                `;
                 navButtons.classList.remove('hidden', 'justify-between');
                 navButtons.classList.add('flex', 'justify-center');
            }


            // 2. Clear and set active styling
            // Reset styling for the new buttons set
            const allNavButtons = navButtons.querySelectorAll('button');
            allNavButtons.forEach(btn => {
                btn.classList.remove('bg-custom-purple', 'text-white', 'bg-red-500');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            let activeNavId = '';
            
            // 3. Render the view
            switch (page) {
                case 'home':
                    renderHomeView(content);
                    break;
                case 'admin_register':
                    renderAdminRegisterView(content);
                    break;
                case 'admin_login':
                    renderAdminLoginView(content);
                    break;
                case 'register':
                    renderRegisterView(content);
                    activeNavId = 'nav-register';
                    break;
                case 'admin_scan':
                    renderAdminScanView(content);
                    activeNavId = 'nav-admin';
                    break;
                case 'children_list': // NEW Admin View: Search List
                    if (isAdmin) {
                        renderChildrenListView(content);
                        activeNavId = 'nav-list';
                    } else {
                         navigate('home');
                    }
                    break;
                case 'profile':
                    // Profile view is only accessible if logged in as admin
                    if (isAdmin) {
                        renderProfileView(content, currentChildId);
                        activeNavId = 'nav-admin'; // Highlight scan button if viewing profile
                    } else {
                        // If a child scans their QR but is not logged in as admin, they see their history
                        navigate('child_history', currentChildId); 
                    }
                    break;
                case 'history_search':
                    renderHistorySearchView(content);
                    activeNavId = 'nav-history';
                    break;
                case 'child_history':
                    renderChildHistoryView(content, currentChildId);
                    activeNavId = 'nav-history'; // Highlight history button if viewing history
                    break;
            }

            // 4. Apply active state styling
            const activeBtn = document.getElementById(activeNavId);
            if (activeBtn) {
                activeBtn.classList.add('bg-custom-purple', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            }
        }
        
        /**
         * Renders the new home view with Khadem/Makhdoum choice.
         */
        function renderHomeView(container) {
            container.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-8 text-custom-purple text-center">أهلاً بك في خدمة المتابعة</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- Khadem Button -->
                        <button onclick="navigate('admin_login')" class="large-home-btn border-custom-purple hover:bg-custom-purple hover:text-white transition duration-200 rounded-xl">
                            <span class="text-4xl mb-2">🧑‍💻</span>
                            <span class="text-xl font-bold">هل أنت خادم؟</span>
                            <span class="text-sm mt-1">(لتسجيل الحضور والمتابعة)</span>
                        </button>
                        
                        <!-- Makhdoum Button -->
                        <button onclick="navigate('register')" class="large-home-btn border-green-500 hover:bg-green-500 hover:text-white transition duration-200 rounded-xl">
                            <span class="text-4xl mb-2">👦👧</span>
                            <span class="text-xl font-bold">هل أنت مخدوم؟</span>
                            <span class="text-sm mt-1">(للتسجيل وعرض السجل)</span>
                        </button>
                    </div>

                    <div class="mt-8 text-center">
                         <p class="text-gray-600 mb-2">لو لم يكن لديك حساب خادم، يمكنك إنشائه من هنا:</p>
                         <button onclick="navigate('admin_register')" class="text-sm text-custom-purple hover:underline">إنشاء حساب خادم جديد</button>
                    </div>

                </div>
            `;
        }

        /**
         * Renders the Khadem Registration Form (Admin Register). - Now a link to Google sign-in
         */
        function renderAdminRegisterView(container) {
             container.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-lg mx-auto text-center">
                    <h2 class="text-2xl font-bold mb-6 text-custom-purple border-b pb-2">إنشاء حساب خادم جديد</h2>
                    <p class="mb-6 text-gray-700">لتسهيل عملية الدخول والأمان، يتم إنشاء حساب الخادم عبر Google مباشرةً.</p>
                    
                    <button onclick="handleAdminRegister()" class="w-full google-btn rounded-lg transition duration-200 hover:opacity-90">
                         <svg class="google-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 11.75C12.4142 11.75 12.75 12.0858 12.75 12.5V16C12.75 16.4142 12.4142 16.75 12 16.75C11.5858 16.75 11.25 16.4142 11.25 16V12.5C11.25 12.0858 11.5858 11.75 12 11.75Z" fill="#4285F4"/>
                            <path d="M12 7.25C12.4142 7.25 12.75 7.5858 12.75 8V10.25C12.75 10.6642 12.4142 11 12 11C11.5858 11 11.25 10.6642 11.25 10.25V8C11.25 7.5858 11.5858 7.25 12 7.25Z" fill="#4285F4"/>
                            <path d="M21 12.5C21 7.25 16.75 3 11.5 3C6.25 3 2 7.25 2 12.5C2 17.75 6.25 22 11.5 22C16.75 22 21 17.75 21 12.5ZM11.5 20.5C7.0875 20.5 3.5 16.9125 3.5 12.5C3.5 8.0875 7.0875 4.5 11.5 4.5C15.9125 4.5 19.5 8.0875 19.5 12.5C19.5 16.9125 15.9125 20.5 11.5 20.5Z" fill="#4285F4"/>
                            <path d="M11.5 18.25C11.5 18.6642 11.8358 19 12.25 19H14C14.4142 19 14.75 18.6642 14.75 18.25C14.75 17.8358 14.4142 17.5 14 17.5H12.25C11.8358 17.5 11.5 17.8358 11.5 18.25Z" fill="#4285F4"/>
                            <path d="M11.5 6.25C11.5 6.66421 11.8358 7 12.25 7H14C14.4142 7 14.75 6.66421 14.75 6.25C14.75 5.83579 14.4142 5.5 14 5.5H12.25C11.8358 5.5 11.5 5.83579 11.5 6.25Z" fill="#4285F4"/>
                        </svg>

                        تسجيل حساب خادم عبر Google
                    </button>

                    <button onclick="navigate('admin_login')" class="mt-4 w-full text-sm text-gray-600 hover:underline">لديك حساب بالفعل؟ تسجيل دخول</button>
                    <button onclick="navigate('home')" class="mt-2 w-full text-sm text-gray-600 hover:underline">العودة للصفحة الرئيسية</button>
                </div>
            `;
        }


        /**
         * Renders the Admin Login Form (Khadem Login). - Now a button for Google Sign-in
         */
        function renderAdminLoginView(container) {
             container.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-lg mx-auto text-center">
                    <h2 class="text-2xl font-bold mb-6 text-red-500 border-b pb-2">🔒 تسجيل دخول الخادم</h2>
                    <p class="mb-4 text-gray-700">يتم الدخول الآن باستخدام حساب Google الخاص بك:</p>
                    
                    <button onclick="handleGoogleLogin()" class="w-full google-btn rounded-lg transition duration-200 hover:opacity-90">
                        <svg class="google-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 11.75C12.4142 11.75 12.75 12.0858 12.75 12.5V16C12.75 16.4142 12.4142 16.75 12 16.75C11.5858 16.75 11.25 16.4142 11.25 16V12.5C11.25 12.0858 11.5858 11.75 12 11.75Z" fill="#4285F4"/>
                            <path d="M12 7.25C12.4142 7.25 12.75 7.5858 12.75 8V10.25C12.75 10.6642 12.4142 11 12 11C11.5858 11 11.25 10.6642 11.25 10.25V8C11.25 7.5858 11.5858 7.25 12 7.25Z" fill="#4285F4"/>
                            <path d="M21 12.5C21 7.25 16.75 3 11.5 3C6.25 3 2 7.25 2 12.5C2 17.75 6.25 22 11.5 22C16.75 22 21 17.75 21 12.5ZM11.5 20.5C7.0875 20.5 3.5 16.9125 3.5 12.5C3.5 8.0875 7.0875 4.5 11.5 4.5C15.9125 4.5 19.5 8.0875 19.5 12.5C19.5 16.9125 15.9125 20.5 11.5 20.5Z" fill="#4285F4"/>
                            <path d="M11.5 18.25C11.5 18.6642 11.8358 19 12.25 19H14C14.4142 19 14.75 18.6642 14.75 18.25C14.75 17.8358 14.4142 17.5 14 17.5H12.25C11.8358 17.5 11.5 17.8358 11.5 18.25Z" fill="#4285F4"/>
                            <path d="M11.5 6.25C11.5 6.66421 11.8358 7 12.25 7H14C14.4142 7 14.75 6.66421 14.75 6.25C14.75 5.83579 14.4142 5.5 14 5.5H12.25C11.8358 5.5 11.5 5.83579 11.5 6.25Z" fill="#4285F4"/>
                        </svg>
                        تسجيل الدخول عبر Google
                    </button>

                    <button onclick="navigate('admin_register')" class="mt-4 w-full text-sm text-gray-600 hover:underline">لا يوجد حساب؟ إنشاء حساب خادم جديد</button>
                    <button onclick="navigate('home')" class="mt-2 w-full text-sm text-gray-600 hover:underline">العودة للصفحة الرئيسية</button>
                </div>
            `;
        }


        /**
         * Renders the registration form.
         */
        function renderRegisterView(container) {
            container.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-lg mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-custom-purple border-b pb-2">استمارة تسجيل الحضور</h2>
                    <form id="registration-form" class="space-y-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">الاسم بالكامل:</label>
                            <input type="text" id="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                        </div>
                        <div>
                            <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">الصف/الخدمة:</label>
                            <input type="text" id="grade" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف (للتواصل):</label>
                            <input type="tel" id="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                        </div>
                        <button type="submit" class="w-full primary-btn bg-custom-purple text-white rounded-lg hover:bg-purple-700">تسجيل وحفظ</button>
                    </form>
                    
                    <div id="registration-result" class="mt-6 p-4 border-l-4 border-green-500 bg-green-50 rounded-lg hidden">
                        <p class="font-bold text-green-700 mb-2">تم التسجيل بنجاح! 🎉</p>
                        <p class="text-gray-700 mb-4">هذا هو الكود الخاص بك (الـ QR Code):</p>
                        <div id="qr-code-area" class="text-center p-4 border-4 border-gray-200 rounded-lg">
                            <!-- QR Code will be generated here -->
                        </div>
                        <p class="mt-4 text-sm text-center text-gray-500">احفظ هذا الـ QR Code لكي يتم مسحه لتسجيل حضورك.</p>
                        <button onclick="navigate('home')" class="mt-4 w-full primary-btn bg-green-500 text-white rounded-lg hover:bg-green-600">العودة للصفحة الرئيسية</button>
                    </div>
                </div>
            `;
            document.getElementById('registration-form').onsubmit = handleRegistration;
        }


        /**
         * Handles registration form submission and saves data to Firestore.
         */
        async function handleRegistration(e) {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const grade = document.getElementById('grade').value.trim();
            const phone = document.getElementById('phone').value.trim();

            const formButton = e.target.querySelector('button[type="submit"]');
            formButton.disabled = true;
            formButton.innerHTML = '<div class="animate-spin inline-block w-5 h-5 border-4 border-t-4 border-white border-t-transparent rounded-full mr-2"></div> جاري الحفظ...';
            
            let childId;

            if (!isFirebaseActive) {
                childId = 'MOCK-ID-' + Math.random().toString(36).substring(2, 9).toUpperCase();

                showModal('⚠️ وضع المحاكاة', 'لا يمكن حفظ البيانات! يجب تشغيل التطبيق في بيئة Canvas أو إعداد Firebase يدوياً.', `
                    <p class="text-xs text-red-500 mb-3">
                        سيتم عرض الـ ID ولكن لن يتم حفظه في قاعدة البيانات.
                    </p>
                `);
            } else {
                try {
                    // Add a new document (child) to the 'children' collection
                    const docRef = await addDoc(collection(db, getChildrenCollectionPath()), {
                        name,
                        grade,
                        phone,
                        createdAt: new Date().toISOString(),
                    });
                    childId = docRef.id;
                    showModal('نجاح التسجيل', 'تم تسجيل بياناتك بنجاح! احفظ الكود الظاهر لتسجيل الحضور.');

                } catch (error) {
                    console.error("Error saving child data: ", error);
                    showModal('خطأ في الحفظ', 'حدث خطأ أثناء حفظ البيانات. الرجاء المحاولة مرة أخرى.');
                    formButton.disabled = false;
                    formButton.innerText = 'تسجيل وحفظ';
                    return;
                }
            }

            // Construct the link for the QR code (simulating the scan)
            const qrLink = `${window.location.origin}${window.location.pathname}?id=${childId}`;

            // Reset QR area and display ID
            const qrCodeArea = document.getElementById('qr-code-area');
            qrCodeArea.innerHTML = `
                <div id="qrcode-canvas" class="mx-auto" style="width:200px; height:200px;"></div>
                <p class="mt-4 text-xs font-mono break-all text-gray-600">${childId}</p>
            `;
            
            // Generate QR Code locally using qrcode.js
            new QRCode(document.getElementById("qrcode-canvas"), {
                text: qrLink,
                width: 200,
                height: 200,
                colorDark : "#6B46C1",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });


            document.getElementById('registration-form').classList.add('hidden');
            document.getElementById('registration-result').classList.remove('hidden');
            
            formButton.disabled = false;
            formButton.innerText = 'تسجيل وحفظ';
        }


        /**
         * Renders the admin (QR scanning simulator) view.
         */
        function renderAdminScanView(container) {
            container.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-lg mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-custom-purple border-b pb-2">صفحة الإدارة (مسح QR)</h2>
                    <p class="mb-4 text-gray-700">أدخل الكود الخاص بالولد يدوياً أو بعد مسحه لفتح ملف المتابعة.</p>
                    <form id="admin-scan-form" class="space-y-4">
                        <div>
                            <label for="child-id-input" class="block text-sm font-medium text-gray-700 mb-1">كود الولد (Child ID):</label>
                            <input type="text" id="child-id-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple" placeholder="الصقهنا أو أدخله يدوياً">
                        </div>
                        <button type="submit" class="w-full primary-btn bg-blue-500 text-white rounded-lg hover:bg-blue-600">فتح ملف المتابعة</button>
                    </form>
                </div>
            `;
            document.getElementById('admin-scan-form').onsubmit = handleAdminScan;
        }

        /**
         * Handles manual ID input (simulating QR scan).
         */
        async function handleAdminScan(e) {
            e.preventDefault();
            const id = document.getElementById('child-id-input').value.trim();
            
            if (!isFirebaseActive) {
                showModal('⚠️ وضع المحاكاة', 'لا يمكن جلب البيانات! يجب تشغيل التطبيق في بيئة Canvas.', `
                    <p class="text-xs text-red-500 mb-3">
                        للتجربة: يمكنك استخدام أي كود، ولكن لن يتم عرض ملف الولد.
                    </p>
                `);
                 return;
            }

            if (id) {
                 // Check if the ID is valid before navigating
                const docRef = doc(db, getChildrenCollectionPath(), id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                     // Navigate to profile view and update URL (simulating a real QR scan link)
                    const newUrl = `${window.location.origin}${window.location.pathname}?id=${id}`;
                    window.history.pushState({ id: id }, `Profile for ${id}`, newUrl);
                    navigate('profile', id);
                } else {
                    showModal('كود غير صحيح', 'لم يتم العثور على ولد بهذا الكود (ID). تأكد من الكود المدخل.');
                }
            }
        }

        // --- NEW: Admin Children List/Search View ---
        /**
         * Renders the view for searching and listing children (Admin only).
         */
        function renderChildrenListView(container) {
             container.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-custom-purple border-b pb-2">🔍 البحث عن مخدوم</h2>
                    <p class="mb-4 text-gray-700">ابحث باسم المخدوم أو بكوده (ID) لفتح ملف المتابعة الخاص به.</p>
                    
                    <form onsubmit="event.preventDefault(); handleSearchChildren()" class="space-y-4 mb-6">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="search-query" required class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple" placeholder="أدخل اسم الولد أو كوده">
                            <button type="submit" id="search-btn" class="primary-btn bg-green-500 text-white rounded-lg hover:bg-green-600 w-full sm:w-auto px-6">بحث</button>
                        </div>
                    </form>

                    <div id="search-results" class="space-y-3 max-h-96 overflow-y-auto border p-4 rounded-lg bg-gray-50">
                        <p class="text-gray-500 text-center">نتائج البحث ستظهر هنا...</p>
                    </div>
                </div>
            `;
        }

        /**
         * Handles the search logic for children documents.
         */
        window.handleSearchChildren = async function() {
            if (!isFirebaseActive) {
                return showModal('⚠️ وضع المحاكاة', 'لا يمكن البحث عن البيانات بدون اتصال بقاعدة بيانات Firebase.');
            }

            const queryText = document.getElementById('search-query').value.trim();
            const resultsContainer = document.getElementById('search-results');
            const searchButton = document.getElementById('search-btn');

            if (!queryText) {
                resultsContainer.innerHTML = '<p class="text-red-500 text-center">الرجاء إدخال اسم أو كود للبحث.</p>';
                return;
            }

            resultsContainer.innerHTML = '<p class="text-gray-500 text-center"><div class="animate-spin inline-block w-4 h-4 border-2 border-t-2 border-custom-purple border-t-transparent rounded-full mr-2"></div> جاري البحث...</p>';
            searchButton.disabled = true;

            try {
                const childrenColRef = collection(db, getChildrenCollectionPath());
                let docs = [];

                // 1. Check if the query is a potential ID (Firestore ID is usually alphanumeric)
                if (queryText.length > 5 && /^[a-zA-Z0-9]+$/.test(queryText)) {
                    // Try to get by ID directly (most efficient)
                    const docRef = doc(db, getChildrenCollectionPath(), queryText);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        docs.push({ id: docSnap.id, ...docSnap.data() });
                    }
                }

                // 2. Search by Name (using Firestore query logic for partial match starting)
                // Note: Firestore doesn't support fuzzy search, so we search for documents where 
                // the 'name' field starts with the query.
                // We ensure we don't duplicate results if it was found by ID.
                if (docs.length === 0 || !docs.some(d => d.name.toLowerCase().includes(queryText.toLowerCase()))) {
                    // Start search (case-insensitive approximation)
                    const q = query(
                        childrenColRef, 
                        where('name', '>=', queryText),
                        where('name', '<=', queryText + '\uf7ff') // Unicode trick for "starts with"
                    );
                    
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(docSnap => {
                         // Only add if not already added by ID search
                        if (!docs.some(d => d.id === docSnap.id)) {
                             // Basic case-insensitive filter in JS because Unicode trick is case-sensitive for Firestore
                             if (docSnap.data().name.toLowerCase().startsWith(queryText.toLowerCase())) {
                                 docs.push({ id: docSnap.id, ...docSnap.data() });
                             }
                        }
                    });
                }


                if (docs.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-red-500 text-center">⚠️ لم يتم العثور على أي مخدومين بالاسم أو الكود المدخل.</p>';
                } else {
                    resultsContainer.innerHTML = docs.map(child => `
                        <div onclick="navigate('profile', '${child.id}')" class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded-lg bg-white hover:bg-blue-50 cursor-pointer border-b border-gray-100 transition duration-150">
                            <div class="flex-grow">
                                <span class="font-bold text-lg text-gray-800">${child.name}</span>
                                <span class="text-sm text-gray-500 block sm:inline-block sm:mr-4">(${child.grade})</span>
                            </div>
                            <span class="text-xs font-mono text-custom-purple mt-1 sm:mt-0">ID: ${child.id}</span>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error("Error searching children:", error);
                resultsContainer.innerHTML = '<p class="text-red-600 text-center">خطأ في البحث: الرجاء مراجعة الـ Console.</p>';
            } finally {
                searchButton.disabled = false;
                searchButton.innerText = 'بحث';
            }
        }
        // --- END: NEW Admin Children List/Search View ---

        /**
         * Renders the child's profile view for admin attendance tracking.
         */
        function renderProfileView(container, childId) {
            if (!childId) {
                container.innerHTML = '<p class="text-red-600 text-center mt-8">خطأ: لم يتم تحديد كود الولد للمتابعة.</p>';
                return;
            }
            
            if (!isFirebaseActive) {
                 container.innerHTML = `
                    <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto text-center">
                        <h2 class="text-2xl font-bold mb-4 text-red-500">⚠️ وضع المحاكاة</h2>
                        <p class="text-gray-700 mb-4">لا يوجد اتصال بقاعدة البيانات (Firebase). لا يمكن عرض ملف المتابعة أو تسجيل الحضور.</p>
                        <p class="text-sm text-gray-500">الرجاء تشغيل التطبيق في بيئة Canvas لاستخدام وظيفة المتابعة.</p>
                        <button onclick="navigate('admin_scan')" class="mt-6 primary-btn bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">العودة لصفحة الإدارة</button>
                    </div>
                `;
                 return;
            }

            container.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-custom-purple">ملف متابعة: <span id="child-name-display" class="text-gray-800">جاري التحميل...</span></h2>
                    <p class="text-gray-500 mb-6">الصف/الخدمة: <span id="child-grade-display" class="font-semibold">...</span></p>

                    <h3 class="text-xl font-bold mb-4 border-b pb-2">تسجيل حضور اليوم: ${formatDateToDocId(new Date())}</h3>
                    <div id="attendance-status" class="mb-6 p-4 rounded-lg bg-gray-100 flex justify-around text-center">
                        <div>
                            <p class="font-medium text-gray-700">القداس:</p>
                            <p id="mass-status" class="text-lg font-bold ${isAdmin ? 'text-red-500' : 'text-gray-500'}">غير مسجل</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-700">الإجتماع:</p>
                            <p id="meeting-status" class="text-lg font-bold ${isAdmin ? 'text-red-500' : 'text-gray-500'}">غير مسجل</p>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 mb-8">
                        ${isAdmin ? `
                           <button onclick="recordAttendance('${childId}', 'mass', this)" class="flex-1 primary-btn bg-green-500 text-white rounded-lg hover:bg-green-600" data-type="mass">✅ تسجيل حضور القداس</button>
                           <button onclick="recordAttendance('${childId}', 'meeting', this)" class="flex-1 primary-btn bg-indigo-500 text-white rounded-lg hover:bg-indigo-600" data-type="meeting">✅ تسجيل حضور الإجتماع</button>
                        ` : `
                           <p class="text-center w-full text-gray-600 font-semibold p-3 border border-gray-300 rounded-lg">الرجاء تسجيل الدخول كخادم لتسجيل الحضور.</p>
                        `}
                    </div>
                    
                    <button onclick="navigate('children_list')" class="mt-4 w-full primary-btn bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">العودة لقائمة البحث</button>

                    <h3 class="text-xl font-bold mb-4 border-b pb-2 mt-8">سجل الحضور بالتواريخ</h3>
                    <div id="attendance-history" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">جارِ تحميل السجل...</p>
                    </div>
                </div>
            `;
            
            // Start fetching data and listening for changes
            loadChildProfileAndAttendance(childId);
        }

        /**
         * Loads child details and sets up real-time attendance listener.
         */
        async function loadChildProfileAndAttendance(childId) {
            // 1. Load Child Details
            const childDocRef = doc(db, getChildrenCollectionPath(), childId);
            try {
                const childSnap = await getDoc(childDocRef);
                if (childSnap.exists()) {
                    const data = childSnap.data();
                    document.getElementById('child-name-display').innerText = data.name;
                    document.getElementById('child-grade-display').innerText = data.grade;
                } else {
                    showModal('خطأ', 'لم يتم العثور على ملف الولد.');
                    // If QR scan fails, go back to appropriate view
                    navigate(isAdmin ? 'admin_scan' : 'history_search'); 
                    return;
                }
            } catch (error) {
                console.error("Error loading child profile:", error);
                showModal('خطأ في قاعدة البيانات', 'لم نتمكن من الوصول لملف الولد.');
                return;
            }

            // 2. Setup Real-time Attendance Listener
            const attendanceCollectionRef = collection(db, getAttendanceCollectionPath(childId));
            
            // onSnapshot for real-time updates
            onSnapshot(attendanceCollectionRef, (snapshot) => {
                const historyContainer = document.getElementById('attendance-history');
                if (!historyContainer) return; // Guard for view change

                const todayDocId = formatDateToDocId(new Date());
                let todayAttendance = { mass: false, meeting: false }; // Initialize for use below
                const allAttendance = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allAttendance.push({ id: doc.id, ...data });
                    if (doc.id === todayDocId) {
                        todayAttendance = { mass: data.mass || false, meeting: data.meeting || false };
                    }
                });

                // Update Today's Status
                document.getElementById('mass-status').className = todayAttendance.mass ? 'text-lg font-bold text-green-600' : 'text-lg font-bold text-red-500';
                document.getElementById('mass-status').innerText = todayAttendance.mass ? 'حضر' : 'غير مسجل';

                document.getElementById('meeting-status').className = todayAttendance.meeting ? 'text-lg font-bold text-green-600' : 'text-lg font-bold text-red-500';
                document.getElementById('meeting-status').innerText = todayAttendance.meeting ? 'حضر' : 'غير مسجل';

                // Render History (Sort by date descending)
                allAttendance.sort((a, b) => b.id.localeCompare(a.id));

                if (allAttendance.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-500 p-4">لم يتم تسجيل أي حضور حتى الآن.</p>';
                    return;
                }

                historyContainer.innerHTML = allAttendance.map(att => `
                    <div class="flex justify-between items-center p-3 rounded-lg ${att.id === todayDocId ? 'bg-yellow-100 border-l-4 border-yellow-500' : 'bg-gray-50'}">
                        <span class="font-bold text-gray-800">${att.id}</span>
                        <div class="flex space-x-3 space-x-reverse">
                            <span class="text-sm font-medium ${att.mass ? 'text-green-600' : 'text-red-500'}">
                                القداس: ${att.mass ? 'حضر' : 'غائب'}
                            </span>
                            <span class="text-sm font-medium ${att.meeting ? 'text-green-600' : 'text-red-500'}">
                                الإجتماع: ${att.meeting ? 'حضر' : 'غائب'}
                            </span>
                        </div>
                    </div>
                `).join('');

            }, (error) => {
                console.error("Error setting up snapshot listener:", error);
                showModal('خطأ في المتابعة', 'حدث خطأ أثناء تحميل سجل الحضور في الوقت الفعلي.');
            });
        }

        /**
         * Records attendance for mass or meeting for the current date.
         * Added 'button' argument for visual feedback.
         */
        window.recordAttendance = async function(childId, type, button) {
            if (!isAdmin) {
                return showModal('صلاحيات مطلوبة', 'يجب أن تكون مسجلاً كـ "خادم" لتسجيل الحضور.');
            }
            
            button.disabled = true;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="animate-spin inline-block w-5 h-5 border-4 border-t-4 border-white border-t-transparent rounded-full mr-2"></div> جاري التسجيل...';


            const todayDocId = formatDateToDocId(new Date());
            const attendanceDocRef = doc(db, getAttendanceCollectionPath(childId), todayDocId);

            const dataToUpdate = {
                date: todayDocId,
                [`${type}`]: true, // mass: true or meeting: true
                [`${type}Timestamp`]: Date.now()
            };

            try {
                // Use setDoc with merge: true to create the document if it doesn't exist, 
                // or update only the specified fields if it does.
                await setDoc(attendanceDocRef, dataToUpdate, { merge: true });
                showModal('تسجيل ناجح', `تم تسجيل حضور ${type === 'mass' ? 'القداس' : 'الإجتماع'} لتاريخ اليوم بنجاح.`);
            } catch (error) {
                console.error(`Error recording ${type} attendance:`, error);
                showModal('خطأ في التسجيل', `حدث خطأ أثناء محاولة تسجيل حضور ${type === 'mass' ? 'القداس' : 'الإجتماع'}.`);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        // ... (omitted remaining functions for brevity) ...
        
        /**
         * Renders the search view for children to check their own history.
         */
        function renderHistorySearchView(container) {
            container.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-lg mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-custom-purple border-b pb-2">عرض سجل الحضور الخاص بي</h2>
                    <p class="mb-4 text-gray-700">أدخل الكود الخاص بك (ID) لعرض سجل حضورك:</p>
                    <form id="history-search-form" class="space-y-4">
                        <div>
                            <label for="history-id-input" class="block text-sm font-medium text-gray-700 mb-1">كود الولد (Child ID):</label>
                            <input type="text" id="history-id-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple" placeholder="أدخل كود التسجيل هنا">
                        </div>
                        <button type="submit" class="w-full primary-btn bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">عرض السجل</button>
                    </form>
                </div>
            `;
            document.getElementById('history-search-form').onsubmit = handleHistorySearch;
        }
        
        /**
         * Handles history search form submission.
         */
        async function handleHistorySearch(e) {
            e.preventDefault();
            const id = document.getElementById('history-id-input').value.trim();
             if (!isFirebaseActive) {
                showModal('⚠️ وضع المحاكاة', 'لا يمكن جلب البيانات! يجب تشغيل التطبيق في بيئة Canvas.', `
                    <p class="text-xs text-red-500 mb-3">
                        للتجربة: يمكنك استخدام أي كود، ولكن لن يتم عرض ملف الولد.
                    </p>
                `);
                 return;
            }

            if (id) {
                 // Check if the ID is valid
                const docRef = doc(db, getChildrenCollectionPath(), id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    navigate('child_history', id);
                } else {
                    showModal('كود غير صحيح', 'لم يتم العثور على ملفك بهذا الكود (ID). تأكد من الكود المدخل.');
                }
            }
        }
        
        /**
         * Renders the full attendance history for the child.
         */
        function renderChildHistoryView(container, childId) {
            if (!childId) {
                container.innerHTML = '<p class="text-red-600 text-center mt-8">خطأ: لم يتم تحديد كود الولد.</p>';
                return;
            }
            
            if (!isFirebaseActive) {
                 container.innerHTML = `
                    <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto text-center">
                        <h2 class="text-2xl font-bold mb-4 text-red-500">⚠️ وضع المحاكاة</h2>
                        <p class="text-gray-700 mb-4">لا يوجد اتصال بقاعدة البيانات (Firebase). لا يمكن عرض سجل الحضور.</p>
                        <p class="text-sm text-gray-500">الرجاء تشغيل التطبيق في بيئة Canvas لعرض البيانات الحقيقية.</p>
                         <button onclick="navigate('history_search')" class="mt-6 primary-btn bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">🔍 بحث عن كود آخر</button>
                    </div>
                `;
                 return;
            }

             container.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-custom-purple border-b pb-2">سجل حضوري</h2>
                    <p class="text-gray-600 mb-6">الاسم: <span id="child-history-name" class="font-semibold">جاري التحميل...</span></p>

                    <h3 class="text-xl font-bold mb-4">تفاصيل الحضور</h3>
                    <div id="child-attendance-list" class="space-y-3 max-h-[70vh] overflow-y-auto">
                        <p class="text-gray-500">جارِ تحميل السجل...</p>
                    </div>
                     <button onclick="navigate('history_search')" class="mt-6 w-full primary-btn bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">🔍 بحث عن كود آخر</button>
                </div>
            `;
            
            // Load and listen for data
            loadChildHistory(childId);
        }

        /**
         * Loads child history details and sets up real-time attendance listener for the child view.
         */
        async function loadChildHistory(childId) {
             // 1. Load Child Details
            const childDocRef = doc(db, getChildrenCollectionPath(), childId);
            try {
                const childSnap = await getDoc(childDocRef);
                if (childSnap.exists()) {
                    const data = childSnap.data();
                    document.getElementById('child-history-name').innerText = data.name;
                } else {
                    document.getElementById('child-history-name').innerText = 'غير موجود';
                    return;
                }
            } catch (error) {
                console.error("Error loading child profile:", error);
                document.getElementById('child-history-name').innerText = 'خطأ في التحميل';
                return;
            }


            // 2. Setup Real-time Attendance Listener
            const attendanceCollectionRef = collection(db, getAttendanceCollectionPath(childId));
            
            onSnapshot(attendanceCollectionRef, (snapshot) => {
                const listContainer = document.getElementById('child-attendance-list');
                if (!listContainer) return; // Guard for view change

                const allAttendance = [];
                snapshot.forEach(doc => {
                    allAttendance.push({ id: doc.id, ...doc.data() });
                });

                // Render History (Sort by date descending)
                allAttendance.sort((a, b) => b.id.localeCompare(a.id));

                if (allAttendance.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500 p-4">لم يتم تسجيل أي حضور لك حتى الآن.</p>';
                    return;
                }

                listContainer.innerHTML = allAttendance.map(att => `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 rounded-xl bg-blue-50 border-r-4 border-blue-400">
                        <span class="font-bold text-lg text-blue-800 mb-2 sm:mb-0">${att.id}</span>
                        <div class="flex gap-4 flex-wrap">
                            <span class="text-sm font-medium ${att.mass ? 'text-green-600 bg-green-100' : 'text-red-500 bg-red-100'} px-2 py-1 rounded-full">
                                القداس: ${att.mass ? '✅ حاضر' : '❌ غائب'}
                            </span>
                            <span class="text-sm font-medium ${att.meeting ? 'text-green-600 bg-green-100' : 'text-red-500 bg-red-100'} px-2 py-1 rounded-full">
                                الإجتماع: ${att.meeting ? '✅ حاضر' : '❌ غائب'}
                            </span>
                        </div>
                    </div>
                `).join('');

            }, (error) => {
                console.error("Error setting up history snapshot listener:", error);
                listContainer.innerHTML = '<p class="text-red-600 p-4">خطأ في تحميل البيانات.</p>';
            });
        }


        // Initialize the app on load
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loading').classList.remove('hidden');
            initializeAppAndAuth();
        });

    </script>
</body>
</html>
