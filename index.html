<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¶ÙˆØ± Ø¥Ø¬ØªÙ…Ø§Ø¹Ø§Øª Ùˆ Ù‚Ø¯Ø§Ø³Ø§Øª Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø£Ø­Ø¯</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ø®Ø· "Inter" Ù‡Ùˆ Ø®Ø· Ø£Ø³Ø§Ø³ÙŠØŒ Ù„ÙƒÙ† ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ø±Ø¨ÙŠ Ù…Ù†Ø§Ø³Ø¨ */
        body { font-family: 'Tahoma', sans-serif; background-color: #f0f4f8; }
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        /* ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .primary-btn {
            padding: 1rem;
            font-size: 1.125rem;
            transition: all 0.2s;
        }
        .primary-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        /* ØªØ®ØµÙŠØµ Ù„ÙˆÙ† Ø§Ù„Ø¥Ø®Ù„Ø§Øµ (Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ) */
        .bg-custom-purple { background-color: #6B46C1; }
        .text-custom-purple { color: #6B46C1; }
        .border-custom-purple { border-color: #6B46C1; }
        /* ØªØµÙ…ÙŠÙ… Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ */
        .logout-btn { background-color: #EF4444; }
        .logout-btn:hover { background-color: #DC2626; }
        /* Ù„ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .large-home-btn { 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 150px;
            width: 100%;
            border: 2px solid;
            text-align: center;
        }
        /* Dashboard table responsive styles */
        .dashboard-table-container {
            overflow-x: auto;
            width: 100%;
        }
        .dashboard-table {
            min-width: 800px; /* Minimum width to prevent crushing columns */
        }
        .dashboard-table th, .dashboard-table td {
            padding: 0.75rem;
            text-align: center;
        }
        .dashboard-table thead {
            background-color: #e0e7ff; /* Indigo-100 */
        }
        /* Style for penalty section */
        .bg-penalty { background-color: #fee2e2; }
        .text-penalty { color: #dc2626; }
    </style>
</head>
<body class="p-4 sm:p-6 min-h-screen flex items-start justify-center">

    <div id="app" class="w-full max-w-7xl"> <!-- Increased max-w for dashboard -->
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">ğŸ‘‹ğŸ¼ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</h1>
            <p class="text-gray-600">Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚Ø¯Ø§Ø³Ø§Øª ÙˆØ§Ø¬ØªÙ…Ø§Ø¹Ø§Øª Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø£Ø­Ø¯</p>
            <div id="auth-status-display" class="mt-2 text-sm flex items-center justify-center">
                <span id="user-id-display" class="text-gray-600 font-semibold ml-2">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ù…</span>
                <!-- Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ø®ÙÙŠ Ø§Ù„Ø¢Ù† Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø±Ø³Ù…ÙŠ -->
                <button id="logout-button" onclick="handleLogout()" class="hidden px-3 py-1 text-xs text-white logout-btn rounded-full mr-2">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading" class="hidden text-center p-8 bg-white rounded-xl card transition duration-300">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-custom-purple border-t-transparent rounded-full mb-3"></div>
            <p class="text-lg font-semibold text-gray-700">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>

        <!-- Main Content Area -->
        <div id="content" class="space-y-6">
            <!-- Navigation Buttons -->
            <div id="nav-buttons" class="hidden justify-center space-x-4 space-x-reverse mb-6 flex-wrap gap-2">
                <!-- Buttons will be rendered dynamically -->
            </div>

            <!-- Views will be injected here -->
            <div id="view-content" class="space-y-6">
                <!-- View content (Home, Register, Admin, Profile, etc.) goes here -->
            </div>
        </div>
    </div>

    <!-- Modals (Custom Alerts/Prompts) -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-11/12 max-w-sm card">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-custom-purple"></h3>
            <p id="modal-message" class="mb-6 text-gray-700"></p>
            <div id="modal-body"></div>
            <button onclick="hideModal()" class="w-full primary-btn bg-custom-purple text-white rounded-lg">ØªÙ…</button>
        </div>
    </div>
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, addDoc, getDocs, query, where, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app, db, auth, userId;
        let currentPage = 'home'; // Start on the new home page
        let currentChildId = null; 
        let isFirebaseActive = localStorage.getItem('isFirebaseActive') === 'true' || false;
        let khademName = localStorage.getItem('khademName') || null; // Load Khadem name from local storage
        let registrationQrId = null; // Store the child ID after registration for download/copy
        let registrationChildName = null; // Store the child name for file download naming
        let registrationChildPhotoBase64 = null; // Store the photo base64 string
        let currentPointsSettings = { massPoints: 10, meetingPoints: 5 }; // Global variable for points settings
        
        const ADMIN_PASSWORD = "service2025"; // Ù…ÙˆØ­Ø¯ Ù„ÙƒÙ„ Ø§Ù„Ø®Ø¯Ø§Ù…
        // Global Constant for the service title on the QR image
        const SERVICE_TITLE = "Ø®Ø¯Ù…Ø© ÙØªÙŠØ§Ù† Ø§Ø¹Ø¯Ø§Ø¯Ù‰ ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ø§Ù„Ø¹Ø¸ÙŠÙ… Ù…Ø§Ø±Ø¬Ø±Ø¬Ø³ Ø¨Ø¨Ø§";
        const TITLE_COLOR = '#059669'; // Emerald Green for title text
        const BORDER_COLOR = '#6B46C1'; // Custom Purple for the frame


        // --- Firebase Setup Handling ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        // --- START: CUSTOM CONFIGURATION FOR GITHUB DEPLOYMENT ---
        const GITHUB_FIREBASE_CONFIG = {
             // ğŸš¨ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…ÙƒØ´ÙˆÙ Ù„Ù„Ø¹Ø§Ù„Ù…! Ø§Ø³ØªØ®Ø¯Ù…Ù‡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ¯Ø±Ùƒ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø£Ù…Ù†ÙŠØ©.
             apiKey: "AIzaSyDE3ygOByNVdAI1vJETq6F6eMJHWVF7mcg", 
             authDomain: "sundayschoolattendance-84656.firebaseapp.com", 
             projectId: "sundayschoolattendance-84656", 
             storageBucket: "sundayschoolattendance-84656.appspot.com",
             messagingSenderId: "444562341363",
             appId: "1:444562341363:web:18ffef684df01ae599a686"
        };
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙˆÙÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Canvas (Ø£ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø®Ø§Ø±Ø¬ Canvas)ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub
        if (!firebaseConfig || firebaseConfig.apiKey === 'YOUR_API_KEY') {
             firebaseConfig = GITHUB_FIREBASE_CONFIG;
        }
        
        // Check if real config is provided and is NOT the placeholder 'YOUR_API_KEY'
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
             isFirebaseActive = true;
             localStorage.setItem('isFirebaseActive', 'true');
        } else {
             isFirebaseActive = false;
             localStorage.setItem('isFirebaseActive', 'false');
        }
        // --- END: CUSTOM CONFIGURATION FOR GITHUB DEPLOYMENT ---

        // Set log level for debugging Firestore (optional but helpful)
        setLogLevel('debug');

        // Utility delay function
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        // --- Points Configuration Functions ---
        
        /**
         * @returns {string} The document path for the points configuration settings.
         */
        function getSettingsDocPath() {
             return `artifacts/${appId}/public/data/points_config/current_settings`;
        }

        /**
         * Returns the current points settings (massPoints and meetingPoints).
         */
        function getPointsSettings() {
            return currentPointsSettings;
        }


        // --- Auth and Initialization (Simplified for Anonymous/Token) ---

        /**
         * Initializes Firebase and ensures the user is signed in (via Canvas token or anonymously).
         */
        async function initializeAppAndAuth() {
            
            if (!isFirebaseActive) {
                console.warn("Firebase configuration not found. Running in UI simulation mode.");
                document.getElementById('loading').innerHTML = `<p class="text-red-600 font-bold">âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>`;
                
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                    navigate(currentPage);
                }, 500);
                return;
            }

            // --- Real Firebase Initialization ---
            try {
                // 1. Initialize App and Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                let user;

                // 2. Try to sign in with Canvas Auth Token first (MANDATORY for Canvas environment)
                if (initialAuthToken) {
                    try {
                        const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        user = userCredential.user;
                        console.log("Signed in with Custom Token.");
                    } catch (e) {
                        console.warn("Custom token sign-in failed. Falling back to anonymous login.", e);
                        const userCredential = await signInAnonymously(auth);
                        user = userCredential.user;
                    }
                } else {
                    // 3. If no custom token, sign in anonymously for public access
                    const userCredential = await signInAnonymously(auth);
                    user = userCredential.user;
                }

                // 4. Set up the state.
                userId = user.uid;
                
                // 5. Load point settings before rendering any page that uses them
                await loadCurrentPointsSettings();

                // 6. Hide loading and navigate
                document.getElementById('loading').classList.add('hidden');
                
                const params = new URLSearchParams(window.location.search);
                const idFromUrl = params.get('id');
                
                if (idFromUrl) {
                    currentChildId = idFromUrl;
                    
                    // If a child ID is scanned, go directly to verification view
                    renderAttendanceVerificationView(document.getElementById('view-content'), currentChildId);
                    
                } else {
                    navigate(currentPage);
                }

            } catch (error) {
                console.error("Critical Firebase Initialization Error:", error);
                 // Display specific error message for critical errors
                document.getElementById('loading').innerHTML = `
                    <p class="text-red-600 font-bold">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø±Ø¬Ø©: ${error.message}</p>
                    <p class="text-sm text-red-500 mt-2">
                        Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ø§Ù„Ø®Ø·Ø£ (auth/api-key-not-valid) Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù„Ù‰ GitHubØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙˆØ¶Ø¹ Ù…ÙØªØ§Ø­ API Ø§Ù„ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.
                    </p>
                `;
            }
        }

        /**
         * Loads the current point configuration from Firestore.
         */
        async function loadCurrentPointsSettings() {
             if (!isFirebaseActive) return;
             try {
                 const settingsDocRef = doc(db, getSettingsDocPath());
                 const docSnap = await getDoc(settingsDocRef);

                 if (docSnap.exists()) {
                     const data = docSnap.data();
                     currentPointsSettings = {
                         massPoints: data.massPoints || 10,
                         meetingPoints: data.meetingPoints || 5,
                     };
                     console.log("Loaded points settings:", currentPointsSettings);
                 } else {
                     // Set initial default settings if the document does not exist
                     await setDoc(settingsDocRef, currentPointsSettings);
                     console.log("Initialized default points settings.");
                 }
             } catch (error) {
                 console.error("Error loading points settings:", error);
                 // Keep default values if loading fails
             }
        }
        
        /**
         * Copies the given text to the clipboard.
         */
        window.copyToClipboard = function(text, successMessage, errorMessage) {
            try {
                // Create a temporary input field
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showModal('Ù†Ø¬Ø§Ø­ Ø§Ù„Ù†Ø³Ø®', successMessage);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®', errorMessage || 'ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹.');
            }
        }

        /**
         * Handles admin logout (now just navigating home and clearing name).
         */
        window.handleLogout = function() {
            // Clear Khadem name from global state and local storage
            khademName = null;
            localStorage.removeItem('khademName');
            navigate('home');
            showModal('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ù…Ù† ÙˆØ¶Ø¹ "Ø§Ù„Ø®Ø§Ø¯Ù…" Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.');
        }


        // --- Utility Functions ---

        /**
         * @returns {string} The collection path for public children data.
         */
        function getChildrenCollectionPath() {
             if (isFirebaseActive && typeof __firebase_config === 'undefined') {
                 return `children`;
             }
             return `artifacts/${appId}/public/data/children`;
        }
        
        /**
         * @param {string} childId The ID of the child document.
         * @returns {string} The collection path for the child's attendance sub-collection.
         */
        function getAttendanceCollectionPath(childId) {
            return `${getChildrenCollectionPath()}/${childId}/attendance`;
        }

        /**
         * @param {Date} date - The date object.
         * @returns {string} Date formatted as 'YYYY-MM-DD' for Firestore Doc ID.
         */
        function formatDateToDocId(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        /**
         * Formats Firestore timestamp or date string into a readable format.
         * @param {string|number} timestampOrDate The date string (YYYY-MM-DD) or a timestamp (ms).
         * @returns {string} Formatted date string (DD/MM/YYYY).
         */
        function formatReadableDate(timestampOrDate) {
            let date;
            if (typeof timestampOrDate === 'number') {
                date = new Date(timestampOrDate);
            } else if (typeof timestampOrDate === 'string' && timestampOrDate.includes('-')) {
                // If it's YYYY-MM-DD
                const parts = timestampOrDate.split('-');
                date = new Date(parts[0], parts[1] - 1, parts[2]);
            } else {
                return 'ØºÙŠØ± Ù…ØªØ§Ø­';
            }
            // Use native Arabic formatting if possible, or fallback to DD/MM/YYYY
            if (!isNaN(date)) {
                 return new Intl.DateTimeFormat('ar-EG', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(date);
            }
            return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­';
        }


        /**
         * Shows a custom modal dialog (replaces alert()).
         * @param {string} title 
         * @param {string} message 
         * @param {string} bodyHtml 
         */
        window.showModal = function(title, message, bodyHtml = '') {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal-body').innerHTML = bodyHtml;
            document.getElementById('modal-backdrop').classList.remove('hidden');
        }

        /**
         * Hides the custom modal dialog.
         */
        window.hideModal = function() {
            document.getElementById('modal-backdrop').classList.add('hidden');
        }

        // --- Rendering Functions ---

        /**
         * Renders the new home view with Khadem/Makhdoum choice.
         */
        function renderHomeView(container) {
             container.innerHTML = `
                 <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto">
                     <h2 class="text-3xl font-bold mb-8 text-custom-purple text-center">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h2>
                     
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                         <!-- Khadem/Dashboard Button -->
                         <button onclick="navigate('admin_dashboard')" class="large-home-btn border-custom-purple hover:bg-custom-purple hover:text-white transition duration-200 rounded-xl">
                             <span class="text-4xl mb-2">ğŸ§‘â€ğŸ’»</span>
                             <span class="text-xl font-bold">Ù‡Ù„ Ø£Ù†Øª Ø®Ø§Ø¯Ù…ØŸ</span>
                             <span class="text-sm mt-1">(Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©)</span>
                         </button>
                         
                         <!-- Makhdoum Button - Now navigates to options -->
                         <button onclick="navigate('makhdoum_options')" class="large-home-btn border-green-500 hover:bg-green-500 hover:text-white transition duration-200 rounded-xl">
                             <span class="text-4xl mb-2">ğŸ‘¦ğŸ‘§</span>
                             <span class="text-xl font-bold">Ù‡Ù„ Ø£Ù†Øª Ù…Ø®Ø¯ÙˆÙ…ØŸ</span>
                             <span class="text-sm mt-1">(Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„)</span>
                         </button>
                     </div>

                 </div>
             `;
        }
        
        /**
         * Renders the options view for a Makhdoum (New Registration or Find Code).
         */
        function renderMakhdoumOptionsView(container) {
             container.innerHTML = `
                 <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto">
                     <h2 class="text-3xl font-bold mb-8 text-green-500 text-center">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…</h2>
                     
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-6"> <!-- Changed to 3 columns for better layout -->
                         <!-- New Registration -->
                         <button onclick="navigate('register')" class="large-home-btn border-green-500 hover:bg-green-500 hover:text-white transition duration-200 rounded-xl">
                             <span class="text-4xl mb-2">ğŸ“</span>
                             <span class="text-xl font-bold">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</span>
                             <span class="text-sm mt-1">(Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©)</span>
                         </button>
                         
                         <!-- Find Code (New Search View) -->
                         <button onclick="navigate('find_code_search')" class="large-home-btn border-blue-500 hover:bg-blue-500 hover:text-white transition duration-200 rounded-xl">
                             <span class="text-4xl mb-2">ğŸ”</span>
                             <span class="text-xl font-bold">Ù†Ø³ÙŠØª Ø§Ù„ÙƒÙˆØ¯ / Ø¶Ø§Ø¹ Ù…Ù†ÙŠ</span>
                             <span class="text-sm mt-1">(Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù…Ùƒ)</span>
                         </button>
                         <!-- Check History -->
                          <button onclick="navigate('history_search')" class="large-home-btn border-indigo-500 hover:bg-indigo-500 hover:text-white transition duration-200 rounded-xl">
                              <span class="text-4xl mb-2">ğŸ“ˆ</span>
                              <span class="text-xl font-bold">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±ÙŠ</span>
                              <span class="text-sm mt-1">(ØªØ­ØªØ§Ø¬ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø®Ø§Øµ)</span>
                          </button>
                     </div>
                     
                     <div class="mt-8 text-center">
                         <button onclick="navigate('home')" class="text-sm text-gray-600 hover:underline">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                     </div>
                 </div>
             `;
        }

        /**
         * Renders the registration form.
         */
        function renderRegisterView(container) {
             container.innerHTML = `
                 <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-lg mx-auto">
                     <h2 class="text-2xl font-bold mb-6 text-custom-purple border-b pb-2">Ø§Ø³ØªÙ…Ø§Ø±Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
                     <form id="registration-form" class="space-y-4">
                         <div>
                             <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                             <input type="text" id="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                         </div>
                         <div>
                             <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØµÙ/Ø§Ù„Ø®Ø¯Ù…Ø©:</label>
                             <input type="text" id="grade" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                         </div>
                         <div>
                             <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù„Ù„ØªÙˆØ§ØµÙ„):</label>
                             <input type="tel" id="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                         </div>
                          <!-- NEW: Parent Phone Field -->
                          <div>
                             <label for="parent-phone" class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                             <input type="tel" id="parent-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                          </div>
                          <!-- NEW: Address Field -->
                          <div>
                             <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                             <input type="text" id="address" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                          </div>
                          <!-- Photo Upload Field -->
                          <div class="border p-4 rounded-lg bg-gray-50">
                             <label for="photo-file" class="block text-sm font-medium text-gray-700 mb-2">ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø¯ÙˆÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙØ¶Ù„ ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© ØµØºÙŠØ±Ø©):</label>
                             <input type="file" id="photo-file" accept="image/png, image/jpeg" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-custom-purple file:text-white hover:file:bg-purple-700">
                             <div id="photo-preview-container" class="mt-3 text-center">
                                 <div id="photo-preview" class="w-20 h-20 bg-gray-200 rounded-full mx-auto hidden border-2 border-custom-purple" style="background-size: cover; background-position: center;"></div>
                                 <p id="photo-error-message" class="text-xs text-red-500 mt-1 hidden"></p>
                             </div>
                          </div>
                          <!-- NEW: Birthdate field (Mandatory) -->
                          <div>
                              <label for="birthdate" class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</label>
                              <input type="date" id="birthdate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                          </div>
                         <button type="submit" class="w-full primary-btn bg-custom-purple text-white rounded-lg hover:bg-purple-700">ØªØ³Ø¬ÙŠÙ„ ÙˆØ­ÙØ¸</button>
                     </form>
                     
                     <div id="registration-result" class="mt-6 p-4 border-l-4 border-green-500 bg-green-50 rounded-lg hidden">
                         <p class="font-bold text-green-700 mb-2">ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰</p>
                         <p class="text-gray-700 mb-4">Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ø§Ù„Ù€ QR Code):</p>
                         <div id="qr-code-area" class="text-center p-4 border-4 border-gray-200 rounded-lg">
                             <!-- QR Code will be generated here -->
                         </div>
                         <p class="mt-4 text-sm text-center text-gray-500">Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ù€ QR Code Ù„ÙƒÙŠ ÙŠØªÙ… Ù…Ø³Ø­Ù‡ Ù„ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ.</p>
                         
                         <div class="flex flex-col sm:flex-row gap-2 mt-4">
                             <!-- Download Image Button -->
                             <button id="download-qr-btn" onclick="downloadQrCodeImage()" class="w-full primary-btn bg-red-600 text-white rounded-lg hover:bg-red-700 text-lg">
                                 ğŸ–¼ï¸ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„ÙƒØ§Ø±Ù†ÙŠÙ‡ (Ù…Ù‡Ù…!)
                             </button>
                         </div>
                         <button id="copy-qr-link-btn" onclick="copyRegistrationLink()" class="w-full primary-btn bg-custom-purple text-white rounded-lg hover:bg-purple-700 text-sm mt-2">
                             ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                         </button>
                         <button onclick="navigate('home')" class="mt-4 w-full primary-btn bg-green-500 text-white rounded-lg hover:bg-green-600">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                     </div>
                 </div>
             `;
             document.getElementById('registration-form').onsubmit = handleRegistration;
             // Add listener for file change to preview the image
             document.getElementById('photo-file').addEventListener('change', previewPhoto);
        }
        
        /**
         * Renders the Khadem Admin Dashboard showing all children data.
         */
        function renderAdminDashboardView(container) {
             // CHECK: Redirect to verification if Khadem name is not set
             if (!khademName) {
                 currentPage = 'admin_dashboard'; // Set current page so verification can redirect back here
                 renderAttendanceVerificationView(container, null);
                 return;
             }

             if (!isFirebaseActive) {
                 container.innerHTML = `<p class="text-red-600 text-center mt-8 p-4 bg-white rounded-xl card max-w-2xl mx-auto">âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>`;
                 return;
             }

             container.innerHTML = `
                 <div class="bg-white p-4 sm:p-6 rounded-xl card max-w-full mx-auto">
                     <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4">
                         <h2 class="text-2xl font-bold text-custom-purple">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§Ø¯Ù… (${khademName})</h2>
                         <div class="flex gap-2 mt-3 sm:mt-0">
                             <button onclick="navigate('children_list')" class="px-4 py-2 text-sm font-medium rounded-lg bg-green-500 text-white hover:bg-green-600 transition">ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</button>
                             <button onclick="navigate('settings')" class="px-4 py-2 text-sm font-medium rounded-lg bg-yellow-500 text-white hover:bg-yellow-600 transition">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø·</button>
                         </div>
                     </div>
                     
                     <p class="mb-4 text-gray-700">Ø¬Ø¯ÙˆÙ„ Ø¹Ø±Ø¶ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø© (ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù„Ø­Ø¸ÙŠØ§Ù‹).</p>

                     <div class="dashboard-table-container">
                         <table class="dashboard-table w-full border-collapse border border-gray-200 rounded-lg">
                             <thead>
                                 <tr class="text-sm text-gray-700">
                                     <th class="border p-2">#</th>
                                     <th class="border p-2 text-right">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</th>
                                     <th class="border p-2">Ø§Ù„ØµÙ</th>
                                     <th class="border p-2 text-custom-purple">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                     <th class="border p-2 text-green-600">Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø¯Ø§Ø³</th>
                                     <th class="border p-2 text-indigo-600">Ù…Ø±Ø§Øª Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹</th>
                                     <th class="border p-2">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                                     <th class="border p-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                                 </tr>
                             </thead>
                             <tbody id="admin-dashboard-list">
                                 <!-- Data will be loaded here -->
                                 <tr><td colspan="8" class="text-center p-4 text-gray-500">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…ÙŠÙ†...</td></tr>
                             </tbody>
                         </table>
                     </div>
                 </div>
             `;
             // Start loading data for the dashboard
             loadAdminDashboardData();
        }


        /**
         * Renders the settings view for Khadem to control point values.
         */
        function renderSettingsView(container) {
             if (!khademName) {
                 renderAttendanceVerificationView(container, null);
                 return;
             }

             container.innerHTML = `
                 <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-lg mx-auto">
                     <h2 class="text-2xl font-bold mb-6 text-custom-purple border-b pb-2">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø·</h2>
                     <p class="mb-4 text-gray-700">Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ¯ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯.</p>
                     <form onsubmit="event.preventDefault(); handlePointsSettingsSave(this)" class="space-y-4">
                         <div>
                             <label for="mass-points-input" class="block text-sm font-medium text-gray-700 mb-1">Ù†Ù‚Ø§Ø· Ø­Ø¶ÙˆØ± Ø§Ù„Ù‚Ø¯Ø§Ø³:</label>
                             <input type="number" id="mass-points-input" min="1" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple" placeholder="Ù…Ø«Ø§Ù„: 10">
                         </div>
                         <div>
                             <label for="meeting-points-input" class="block text-sm font-medium text-gray-700 mb-1">Ù†Ù‚Ø§Ø· Ø­Ø¶ÙˆØ± Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹:</label>
                             <input type="number" id="meeting-points-input" min="1" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple" placeholder="Ù…Ø«Ø§Ù„: 5">
                         </div>
                         <button type="submit" id="settings-save-btn" class="w-full primary-btn bg-green-500 text-white rounded-lg hover:bg-green-600">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                     </form>
                 </div>
             `;
             // Load current values into the form
             document.getElementById('mass-points-input').value = getPointsSettings().massPoints;
             document.getElementById('meeting-points-input').value = getPointsSettings().meetingPoints;
        }

        /**
         * Renders the verification view for a Khadem to enter a name and password after scanning QR or clicking Khadem Login.
         */
        function renderAttendanceVerificationView(container, childId) {
             
             let childName = childId ? 'Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…' : 'Ø§Ù„Ø®Ø¯Ù…Ø©';
             if (isFirebaseActive && childId) {
                 const childDocRef = doc(db, getChildrenCollectionPath(), childId);
                 getDoc(childDocRef).then(snap => {
                     if (snap.exists()) {
                         childName = snap.data().name;
                         // Update the visible title if the element exists
                         const titleEl = document.getElementById('verification-title');
                         if (titleEl) titleEl.innerText = `ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${childName}`;
                     }
                 });
             }


             container.innerHTML = `
                 <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-lg mx-auto">
                     <h2 id="verification-title" class="text-2xl font-bold mb-6 text-custom-purple border-b pb-2">${childId ? `ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${childName}` : `ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ®Ø§Ø¯Ù…`}</h2>
                     <p class="mb-4 text-gray-700">Ù„Ù„ØªØ³Ø¬ÙŠÙ„/Ù„Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø®Ø¯Ù…Ø©.</p>
                     <form onsubmit="event.preventDefault(); handleKhademVerification('${childId}')" class="space-y-4">
                         <div>
                             <label for="khadem-name-input" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù…Ùƒ ÙƒØ®Ø§Ø¯Ù…:</label>
                             <input type="text" id="khadem-name-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
                         </div>
                         <div>
                             <label for="khadem-password-input" class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ù…ÙˆØ­Ø¯Ø©:</label>
                             <input type="password" id="khadem-password-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
                         </div>
                         <button type="submit" class="w-full primary-btn bg-red-500 text-white rounded-lg hover:bg-red-600">${childId ? 'Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'}</button>
                     </form>
                     <button onclick="navigate('home')" class="mt-4 w-full text-sm text-gray-600 hover:underline">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                 </div>
             `;

             // Pre-fill name if already known
             if (khademName) {
                 document.getElementById('khadem-name-input').value = khademName;
             }
        }

        // --- Navigation and Main Logic ---

        /**
         * Navigates to a new view and updates the UI.
         * @param {string} page - The target view name.
         * @param {string} [childId=null] - Optional child ID for profile/history views.
         */
        window.navigate = function(page, childId = null) {
            currentPage = page;
            currentChildId = childId;
            const content = document.getElementById('view-content'); 
            const navButtons = document.getElementById('nav-buttons');
            
            content.innerHTML = ''; // Clear previous content

            // Update user status display
            document.getElementById('user-id-display').innerText = khademName ? `Ø®Ø§Ø¯Ù…: ${khademName}` : `Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ù…`;
             // Show/Hide Khadem Logout button based on state
            document.getElementById('logout-button').classList.toggle('hidden', !khademName);


            // 1. Decide which navigation buttons to show
            if (khademName) {
                 // If khademName is set, show Khadem buttons and an option to log out (clear name)
                navButtons.innerHTML = `
                     <button onclick="navigate('admin_dashboard')" id="nav-dashboard" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150 bg-gray-200 text-gray-700 hover:bg-custom-purple hover:text-white">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                     <button onclick="navigate('children_list')" id="nav-list" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150 bg-gray-200 text-gray-700 hover:bg-custom-purple hover:text-white">Ø¨Ø­Ø«/ØªØ³Ø¬ÙŠÙ„ Ø³Ø±ÙŠØ¹</button>
                     <button onclick="navigate('register')" id="nav-register" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150 bg-gray-200 text-gray-700 hover:bg-custom-purple hover:text-white">ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø¯ÙˆÙ… Ø¬Ø¯ÙŠØ¯</button>
                     <button onclick="navigate('settings')" id="nav-settings" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150 bg-gray-200 text-gray-700 hover:bg-custom-purple hover:text-white">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                `;
                navButtons.classList.remove('hidden');
                navButtons.classList.add('flex'); // Add flex if not already there
                
                // Hide logout button from the list since it's next to the user name
                document.getElementById('logout-button').classList.remove('hidden'); 
            } else { 
                 // Public access (Makhdoum/Child)
                 navButtons.innerHTML = `
                      <button onclick="navigate('home')" id="nav-home" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150 bg-gray-200 text-gray-700 hover:bg-custom-purple hover:text-white">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                      <button onclick="navigate('makhdoum_options')" id="nav-options" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150 bg-gray-200 text-gray-700 hover:bg-custom-purple hover:text-white">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…</button>
                 `;
                 navButtons.classList.remove('hidden', 'justify-between');
                 navButtons.classList.add('flex', 'justify-center');
            }


            // 2. Render the view
            let activeNavId = '';
            switch (page) {
                case 'home':
                    renderHomeView(content);
                    activeNavId = 'nav-home';
                    break;
                case 'makhdoum_options':
                    renderMakhdoumOptionsView(content);
                    activeNavId = 'nav-options'; 
                    break;
                case 'find_code_search':
                    renderFindCodeSearchView(content);
                    activeNavId = 'nav-options';
                    break;
                case 'register':
                    renderRegisterView(content);
                    activeNavId = 'nav-register';
                    break;
                case 'children_list':
                    renderChildrenListView(content);
                    activeNavId = 'nav-list';
                    break;
                case 'admin_dashboard': // NEW Dashboard view
                    renderAdminDashboardView(content);
                    activeNavId = 'nav-dashboard';
                    break;
                case 'settings':
                    renderSettingsView(content);
                    activeNavId = 'nav-settings';
                    break;
                case 'profile':
                    renderProfileView(content, currentChildId);
                    activeNavId = 'nav-list'; 
                    break;
                case 'admin_scan': // For direct link simulation
                case 'history_search':
                    renderHistorySearchView(content);
                    activeNavId = 'nav-options';
                    break;
                case 'child_history':
                    renderChildHistoryView(content, currentChildId);
                    activeNavId = 'nav-options';
                    break;
                default:
                    renderHomeView(content);
                    break;
            }

            // 3. Apply active state styling
            // Reset styles first
            document.querySelectorAll('#nav-buttons button').forEach(btn => {
                btn.classList.remove('bg-custom-purple', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            const activeBtn = document.getElementById(activeNavId);
            if (activeBtn) {
                activeBtn.classList.add('bg-custom-purple', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            }
        }
        
        // --- Helper functions (not needing reference fix) ---
        // ... (copyToClipboard, downloadQrCodeImage, previewPhoto, handlePointsSettingsSave - Remain unchanged or minimally adjusted) ...

        let registrationQrLink = null; // Store the generated link for copying

        /**
         * Triggers the download of the final canvas as a PNG file.
         */
        function triggerDownload(finalCanvas) {
            const dataURL = finalCanvas.toDataURL("image/png");
            
            const a = document.createElement('a');
            const cleanedName = registrationChildName.replace(/[^a-z0-9\u0600-\u06FF]/gi, '_').toLowerCase(); 
            a.download = `QR_${cleanedName}_${registrationQrId}.png`;
            a.href = dataURL;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            showModal('Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'ØªÙ… Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„ÙƒØ§Ø±Ù†ÙŠÙ‡ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ!');
        }

        /**
         * Downloads the QR code image as a PNG file, rendered with the service title, QR, name, and ID.
         */
        window.downloadQrCodeImage = function() {
             if (!registrationQrId || !registrationChildName) {
                 return showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙˆØ¯ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
             }

             // 1. Get the existing QR Code canvas
             const qrContainer = document.getElementById('qr-code-area');
             const qrCanvas = qrContainer.querySelector('canvas');

             if (!qrCanvas) {
                 return showModal('Ø®Ø·Ø£ ÙÙ†ÙŠ', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„ÙƒÙˆØ¯ (Canvas) Ù„Ù„ØªØ­Ù…ÙŠÙ„.');
             }

             // --- 2. Create the combined Canvas for the full card ---
             
             const QR_SIZE = 200; // Size of the QR code canvas (fixed from qrcode.js)
             const INNER_PADDING = 15; // Padding inside the drawing area
             const CARD_PADDING = 15; // Padding outside the drawing area / inside the frame
             // NOTE: TEXT_HEIGHT is now calculated dynamically, setting a max card height
             const BORDER_THICKNESS = 8; // Increased border thickness for better visual
             const PHOTO_SIZE = 60; // Size for the circular photo
             const TITLE_HEIGHT = 50; // Estimated height for the wrapped title
             const MARGIN = 25; // Increased Vertical spacing between elements for more breathing room
             const ID_HEIGHT = 45; // Estimated height for ID line to ensure it is visible
             // *** FIX: Increase final padding/height here to prevent cropping ***
             const EXTRA_BOTTOM_PADDING = 70; // Added 70 pixels extra padding for safety. (FIXED)

             // Calculate card dimensions (increased size for better visual separation)
             const innerWidth = QR_SIZE + INNER_PADDING * 2;
             // Total Content Height = Title + Photo + Margin + QR + Margin + Name/ID area
             const contentHeight = TITLE_HEIGHT + PHOTO_SIZE + MARGIN + QR_SIZE + MARGIN + ID_HEIGHT + EXTRA_BOTTOM_PADDING; 
             
             const newCanvasWidth = innerWidth + CARD_PADDING * 2 + BORDER_THICKNESS * 2 + 30; // Added 30 for overall width
             const newCanvasHeight = contentHeight + CARD_PADDING * 2 + BORDER_THICKNESS * 2; 

             const finalCanvas = document.createElement('canvas');
             finalCanvas.width = newCanvasWidth;
             finalCanvas.height = newCanvasHeight;
             const ctx = finalCanvas.getContext('2d');
             
             // --- 3. Draw Outer Frame and Background ---
             
             // 3.1 Draw Frame Border (Custom Purple)
             ctx.fillStyle = BORDER_COLOR;
             ctx.fillRect(0, 0, newCanvasWidth, newCanvasHeight);
             
             // 3.2 Draw Inner Background (White)
             const innerX = BORDER_THICKNESS;
             const innerY = BORDER_THICKNESS;
             const innerW = newCanvasWidth - BORDER_THICKNESS * 2;
             const innerH = newCanvasHeight - BORDER_THICKNESS * 2;
             ctx.fillStyle = '#FFFFFF';
             ctx.fillRect(innerX, innerY, innerW, innerH);

             // --- 4. Draw Content ---
             
             const centerX = newCanvasWidth / 2;
             let currentY = innerY + CARD_PADDING;
             const contentWidth = innerW - CARD_PADDING * 2;


             const drawPhoto = (callback, currentY) => {
                 if (registrationChildPhotoBase64) {
                     const img = new Image();
                     img.onload = function() {
                         // Position photo centered horizontally relative to content width
                         const PHOTO_X = (newCanvasWidth - PHOTO_SIZE) / 2;
                         const PHOTO_Y = currentY + 5; 

                         const radius = PHOTO_SIZE / 2;

                         ctx.save();
                         ctx.beginPath();
                         // Create a circular clipping path
                         ctx.arc(PHOTO_X + radius, PHOTO_Y + radius, radius, 0, Math.PI * 2, true);
                         ctx.closePath();
                         ctx.clip();

                         ctx.drawImage(img, PHOTO_X, PHOTO_Y, PHOTO_SIZE, PHOTO_SIZE);

                         ctx.restore();
                         callback(currentY + PHOTO_SIZE + MARGIN); // Update Y position after photo
                     };
                     img.onerror = function() {
                          console.warn("Failed to load user image for QR card. Drawing card without photo.");
                          callback(currentY + PHOTO_SIZE + MARGIN); 
                     };
                     img.src = registrationChildPhotoBase64;
                 } else {
                     callback(currentY + MARGIN); // Just add margin if no photo
                 }
             };

             // 4.1 Draw Header Text (Service Title - Centered at the very top)
             // Start title drawing slightly offset to allow for top padding (currentY)
             ctx.fillStyle = TITLE_COLOR; // Emerald Green
             ctx.textAlign = 'center';
             
             const titleParts = SERVICE_TITLE.split(' ');
             let line = '';
             let yTitle = currentY + 15;
             const lineHeight = 20;

             ctx.font = 'bold 20px Tahoma, sans-serif'; 

             // Simple wrapping logic for the header
             for (let i = 0; i < titleParts.length; i++) {
                 const testLine = line + titleParts[i] + ' ';
                 const metrics = ctx.measureText(testLine);
                 const testWidth = metrics.width;

                 if (testWidth > contentWidth && i > 0) {
                     ctx.fillText(line.trim(), centerX, yTitle);
                     line = titleParts[i] + ' ';
                     yTitle += lineHeight;
                 } else {
                     line = testLine;
                 }
             }
             ctx.fillText(line.trim(), centerX, yTitle);
             
             // Update currentY after title rendering
             currentY = yTitle + MARGIN; 


             const drawContentAfterPhoto = (newY) => {
                 currentY = newY;
                 
                 // 4.3 Draw QR Code (Centered)
                 const qrX = (newCanvasWidth - QR_SIZE) / 2;
                 const qrYStart = currentY + INNER_PADDING;
                 ctx.drawImage(qrCanvas, qrX, qrYStart, QR_SIZE, QR_SIZE);
                 
                 // 4.4 Draw Footer Text (Name and ID)
                 const footerYStart = qrYStart + QR_SIZE + MARGIN;
                 
                 // Draw Name
                 ctx.fillStyle = '#374151'; // Gray-700
                 ctx.font = 'bold 22px Tahoma, sans-serif'; // Larger font for name
                 ctx.fillText(registrationChildName, centerX, footerYStart + 10);

                 // Draw ID (moved further down)
                 ctx.fillStyle = BORDER_COLOR; // Custom Purple
                 ctx.font = '16px monospace, Tahoma, sans-serif'; // Slightly larger ID font
                 ctx.fillText(`ID: ${registrationQrId}`, centerX, footerYStart + 35); 

                 // --- 5. Trigger Download ---
                 triggerDownload(finalCanvas);
             };

             // 4.2 Start the drawing process: Draw Photo, then the rest
             // Pass the current Y position (after the title) to start drawing the photo
             drawPhoto(drawContentAfterPhoto, currentY);
        }

        /**
         * Handles local file selection for preview and conversion to Base64.
         */
        function previewPhoto(event) {
             const file = event.target.files[0];
             const preview = document.getElementById('photo-preview');
             const errorMessage = document.getElementById('photo-error-message');
             
             if (file) {
                 const reader = new FileReader();
                 
                 // Max file size for embedding in Firestore document (around 100KB is safe)
                 const MAX_SIZE_BYTES = 150 * 1024; // 150 KB
                 
                 errorMessage.classList.add('hidden');
                 
                 if (file.size > MAX_SIZE_BYTES) {
                     errorMessage.innerText = 'âš ï¸ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… 150 ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª)';
                     errorMessage.classList.remove('hidden');
                     preview.classList.add('hidden');
                     registrationChildPhotoBase64 = null;
                     event.target.value = ''; // Clear file input
                     return;
                 }

                 reader.onload = function(e) {
                     const base64String = e.target.result;
                     preview.style.backgroundImage = `url(${base64String})`;
                     preview.classList.remove('hidden');
                     // Store the Base64 string for saving to Firestore and drawing on Canvas
                     registrationChildPhotoBase64 = base64String; 
                 };

                 reader.onerror = function() {
                     errorMessage.innerText = 'Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.';
                     errorMessage.classList.remove('hidden');
                     preview.classList.add('hidden');
                     registrationChildPhotoBase64 = null;
                 }

                 reader.readAsDataURL(file);
             } else {
                 preview.classList.add('hidden');
                 registrationChildPhotoBase64 = null;
             }
        }

        /**
         * Handles saving the points settings to Firestore.
         */
        window.handlePointsSettingsSave = async function(form) {
             if (!isFirebaseActive) {
                 return showModal('âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase.');
             }

             const massPoints = parseInt(document.getElementById('mass-points-input').value, 10);
             const meetingPoints = parseInt(document.getElementById('meeting-points-input').value, 10);
             const saveButton = document.getElementById('settings-save-btn');

             if (isNaN(massPoints) || massPoints < 1 || isNaN(meetingPoints) || meetingPoints < 1) {
                 return showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø© Ù…ÙˆØ¬Ø¨Ø© (Ø£ÙƒØ¨Ø± Ù…Ù† 0) Ù„ÙƒÙ„ Ù…Ù† Ø§Ù„Ù‚Ø¯Ø§Ø³ ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹.');
             }

             saveButton.disabled = true;
             saveButton.innerHTML = '<div class="animate-spin inline-block w-5 h-5 border-4 border-t-4 border-white border-t-transparent rounded-full mr-2"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

             try {
                 const settingsDocRef = doc(db, getSettingsDocPath());
                 const newSettings = { massPoints, meetingPoints };

                 await setDoc(settingsDocRef, newSettings);
                 
                 // Update the global state immediately
                 currentPointsSettings = newSettings; 
                 
                 showModal('Ù†Ø¬Ø§Ø­ Ø§Ù„Ø­ÙØ¸', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯.');

             } catch (error) {
                 console.error("Error saving points settings:", error);
                 showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
             } finally {
                 saveButton.disabled = false;
                 saveButton.innerText = 'Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';
             }
        }


        /**
         * Handles registration form submission and saves data to Firestore.
         */
        async function handleRegistration(e) {
             e.preventDefault();
             const name = document.getElementById('name').value.trim();
             const grade = document.getElementById('grade').value.trim();
             const phone = document.getElementById('phone').value.trim();
             const parentPhone = document.getElementById('parent-phone').value.trim(); // NEW
             const address = document.getElementById('address').value.trim(); // NEW
             const birthdate = document.getElementById('birthdate').value.trim(); 
             
             // Get Base64 string from the global variable updated by previewPhoto
             const photoBase64 = registrationChildPhotoBase64; 

             // Store name globally for file download function
             registrationChildName = name;

             const formButton = e.target.querySelector('button[type="submit"]');
             formButton.disabled = true;
             formButton.innerHTML = '<div class="animate-spin inline-block w-5 h-5 border-4 border-t-4 border-white border-t-transparent rounded-full mr-2"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
             
             let childId;

             if (!isFirebaseActive) {
                 childId = 'MOCK-ID-' + Math.random().toString(36).substring(2, 9).toUpperCase();

                 showModal('âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø¨ÙŠØ¦Ø© Canvas Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ÙŠØ¯ÙˆÙŠØ§Ù‹.', `
                     <p class="text-xs text-red-500 mb-3">
                         Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù€ ID ÙˆÙ„ÙƒÙ† Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
                     </p>
                 `);
             } else {
                 try {
                     // Add a new document (child) to the 'children' collection
                     const docRef = await addDoc(collection(db, getChildrenCollectionPath()), {
                         name,
                         grade,
                         phone,
                         parentPhone, // NEW
                         address,     // NEW
                         birthdate, 
                         photoBase64: photoBase64 || null, // Save photo Base64 string
                         totalPoints: 0, // Initialize total points
                         massTotalCount: 0, // NEW: Initialize mass count
                         meetingTotalCount: 0, // NEW: Initialize meeting count
                         createdAt: new Date().toISOString(), // Use current timestamp for registration date
                     });
                     childId = docRef.id;
                     showModal('Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¸Ø§Ù‡Ø± Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.');

                 } catch (error) {
                     console.error("Error saving child data: ", error);
                     showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                     formButton.disabled = false;
                     formButton.innerText = 'ØªØ³Ø¬ÙŠÙ„ ÙˆØ­ÙØ¸';
                     return;
                 }
             }

             // Store ID globally
             registrationQrId = childId;
             
             // Construct the link for the QR code (simulating the scan)
             registrationQrLink = `${window.location.origin}${window.location.pathname}?id=${childId}`;

             // Reset QR area and display ID
             const qrCodeArea = document.getElementById('qr-code-area');
             qrCodeArea.innerHTML = `
                 <div id="qrcode-canvas" class="mx-auto" style="width:200px; height:200px;"></div>
                 <p class="mt-4 text-xs font-mono break-all text-gray-600">${childId}</p>
             `;
             
             // Generate QR Code locally using qrcode.js
             new QRCode(document.getElementById("qrcode-canvas"), {
                 text: registrationQrLink,
                 width: 200,
                 height: 200,
                 colorDark : "#6B46C1",
                 colorLight : "#ffffff",
                 correctLevel : QRCode.CorrectLevel.H
             });


             document.getElementById('registration-form').classList.add('hidden');
             document.getElementById('registration-result').classList.remove('hidden');
             
             formButton.disabled = false;
             formButton.innerText = 'ØªØ³Ø¬ÙŠÙ„ ÙˆØ­ÙØ¸';
        }
        
        /**
         * Copies the generated registration link (QR code link) to the clipboard.
         */
        window.copyRegistrationLink = function() {
             if (registrationQrLink) {
                 copyToClipboard(
                     registrationQrLink,
                     'ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ QR Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù…Ø´Ø§Ø±ÙƒØªÙ‡.',
                     'ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.'
                 );
             }
        }
        
        let foundQrLink = null; // Store the found link for copying

        /**
         * Copies the found code link to the clipboard.
         */
        window.copyFoundCodeLink = function() {
             if (foundQrLink) {
                 copyToClipboard(
                     foundQrLink,
                     'ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ QR Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø­ÙØ¸Ù‡ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹.',
                     'ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.'
                 );
             }
        }

        /**
         * Handles the search logic for finding an existing code by name.
         */
        window.handleFindCodeSearch = async function() { // Added window. to make it global
             if (!isFirebaseActive) {
                 return showModal('âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase.');
             }

             // Removed .trim() to be more forgiving in Arabic names
             const queryName = document.getElementById('find-code-name-input').value; 
             const trimmedQueryName = queryName.trim(); 
             const resultDiv = document.getElementById('find-code-result');
             const searchButton = document.getElementById('find-code-btn');
             const qrCodeArea = document.getElementById('found-qr-code-area');

             if (!trimmedQueryName) {
                  // If validation fails (empty input), return immediately and show modal
                  showModal('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¨Ø­Ø«.');
                  return;
             }

             // If validation passes, start loading state (this is where the fix prevents it from looking "stuck")
             searchButton.disabled = true;
             searchButton.innerHTML = '<div class="animate-spin inline-block w-5 h-5 border-4 border-t-4 border-white border-t-transparent rounded-full mr-2"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
             resultDiv.classList.add('hidden');
             
             try {
                 const childrenColRef = collection(db, getChildrenCollectionPath());
                 
                 // --- FIX: Use Unicode search on a lowercase/normalized name field if available, 
                 // but since we only have the 'name' field, we rely on the Unicode trick (needs Index) ---
                 
                 const q = query(
                      childrenColRef, 
                      // Using the untrimmed value in the where clause might sometimes help with weird spaces.
                      // Note: This requires a composite index on the 'name' field in Firestore
                      where('name', '>=', queryName),
                      where('name', '<=', queryName + '\uf7ff') 
                 );
                 
                 const querySnapshot = await getDocs(q);
                 let foundDoc = null;
                 
                 // 2. Filter in JavaScript for an EXACT match (case-insensitive and trim spaces)
                 querySnapshot.forEach(docSnap => {
                      // Normalize both names for comparison
                      const storedName = docSnap.data().name.trim().toLowerCase();
                      const enteredName = trimmedQueryName.toLowerCase();

                      if (storedName === enteredName) {
                           foundDoc = docSnap;
                      }
                 });

                 
                 if (foundDoc) {
                      const childId = foundDoc.id;
                      foundQrLink = `${window.location.origin}${window.location.pathname}?id=${childId}`;

                      // Update the QR Code area structure
                      qrCodeArea.innerHTML = `
                          <div id="found-qrcode-canvas" class="mx-auto" style="width:200px; height:200px;"></div>
                          <p class="mt-4 text-xs font-mono break-all text-gray-600">${childId}</p>
                      `;
                      
                      // Generate QR Code 
                      const existingQrCanvas = document.getElementById("found-qrcode-canvas");
                      if (existingQrCanvas) {
                           existingQrCanvas.innerHTML = '';
                           new QRCode(existingQrCanvas, {
                                 text: foundQrLink,
                                 width: 200,
                                 height: 200,
                                 colorDark : "#4285F4", // Use blue color for finding code
                                 colorLight : "#ffffff",
                                 correctLevel : QRCode.CorrectLevel.H
                           });
                      }


                      resultDiv.classList.remove('hidden');
                      document.querySelector('#find-code-result .font-bold').innerText = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø§Ø³Ù…: ${foundDoc.data().name} ğŸ‰`;

                 } else {
                      showModal('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙƒÙ…Ø§ Ø³Ø¬Ù„ØªÙ‡ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰.');
                 }
             } catch (error) {
                 console.error("Error finding code by name:", error);
                 // Check for Index Missing error message structure
                 if (error.message.includes('The query requires an index')) {
                     showModal('Ø®Ø·Ø£: Ù…Ø·Ù„ÙˆØ¨ ÙÙ‡Ø±Ø³ (Index)', `Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø±Ø³ (Index) ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firestore. <br><br>Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙØªØ­ Ø§Ù„Ù€ <strong>Console (F12)</strong> ÙˆØ§ØªØ¨Ø§Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¸Ø§Ù‡Ø± Ù‡Ù†Ø§Ùƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.`);
                 } else {
                     showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                 }
             } finally {
                 searchButton.disabled = false;
                 searchButton.innerHTML = 'Ø¨Ø­Ø« ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ¯';
             }
        }


        /**
         * Handles the Khadem name and password verification.
         */
        window.handleKhademVerification = function(childId) {
             const name = document.getElementById('khadem-name-input').value.trim();
             const password = document.getElementById('khadem-password-input').value.trim();
             const targetPage = currentPage; // Get the page requested before verification

             if (password !== ADMIN_PASSWORD) {
                 return showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
             }

             if (!name) {
                 return showModal('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙƒØ®Ø§Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹.');
             }

             // Save Khadem name globally and to local storage
             khademName = name;
             localStorage.setItem('khademName', name); // Save to local storage for persistence
             showModal('Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ù‚Ù‚', `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${khademName}! Ø¬Ø§Ø±Ù ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.`);
             document.getElementById('user-id-display').innerText = `Ø®Ø§Ø¯Ù…: ${khademName}`;
             
             if (childId && childId !== 'null') { // check if a specific child was scanned
                  // Navigate to the profile view using the verified Khadem Name
                 navigate('profile', childId);
             } else {
                  // If no child was scanned, navigate to the target page (dashboard is the default admin landing)
                 if (targetPage === 'admin_dashboard') {
                      navigate('admin_dashboard');
                 } else if (targetPage === 'children_list') {
                      navigate('children_list');
                 } else {
                      // Default to dashboard if we weren't trying to go to list
                      navigate('admin_dashboard'); 
                 }
             }
        }

        /**
         * Handles the search logic for children documents (Admin Quick Search View).
         */
        window.handleSearchChildren = async function() {
             if (!isFirebaseActive) {
                 return showModal('âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase.');
             }

             const queryText = document.getElementById('search-query').value.trim();
             const resultsContainer = document.getElementById('search-results');
             const searchButton = document.getElementById('search-btn');

             if (!queryText) {
                 resultsContainer.innerHTML = '<p class="text-red-500 text-center">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ù„Ù„Ø¨Ø­Ø«.</p>';
                 return;
             }

             resultsContainer.innerHTML = '<p class="text-gray-500 text-center"><div class="animate-spin inline-block w-4 h-4 border-2 border-t-2 border-custom-purple border-t-transparent rounded-full mr-2"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';
             searchButton.disabled = true;

             try {
                 const childrenColRef = collection(db, getChildrenCollectionPath());
                 let docs = [];

                 // 1. Check if the query is a potential ID (Firestore ID is usually alphanumeric)
                 if (queryText.length > 5 && /^[a-zA-Z0-9]+$/.test(queryText)) {
                      // Try to get by ID directly (most efficient)
                     const docRef = doc(db, getChildrenCollectionPath(), queryText);
                     const docSnap = await getDoc(docRef);
                     if (docSnap.exists()) {
                          docs.push({ id: docSnap.id, ...docSnap.data() });
                     }
                 }

                 // 2. Search by Name (using Firestore query logic for partial match starting)
                 // We use Unicode trick for "starts with"
                 if (docs.length === 0 || !docs.some(d => d.name.toLowerCase().includes(queryText.toLowerCase()))) {
                     const q = query(
                          childrenColRef, 
                          where('name', '>=', queryText),
                          where('name', '<=', queryText + '\uf7ff') 
                     );
                     
                     const querySnapshot = await getDocs(q);
                     querySnapshot.forEach(docSnap => {
                           // Only add if not already added by ID search and name starts with query
                          if (!docs.some(d => d.id === docSnap.id)) {
                               docs.push({ id: doc.id, ...doc.data() });
                          }
                     });
                 }

                 // Remove duplicates based on ID (important if both ID and Name searches found the same doc)
                 const uniqueDocs = Array.from(new Map(docs.map(item => [item.id, item])).values());


                 if (uniqueDocs.length === 0) {
                     resultsContainer.innerHTML = '<p class="text-red-500 text-center">âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø®Ø¯ÙˆÙ…ÙŠÙ† Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯Ø®Ù„.</p>';
                 } else {
                     resultsContainer.innerHTML = uniqueDocs.map(child => {
                          // Photo HTML generation for search results
                          const photoHtml = child.photoBase64 
                               ? `<img src="${child.photoBase64}" class="w-10 h-10 rounded-full border-2 border-custom-purple ml-3 object-cover flex-shrink-0" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…">`
                               : `<div class="w-10 h-10 rounded-full border-2 border-gray-300 ml-3 bg-gray-200 flex items-center justify-center text-gray-500 font-bold text-sm flex-shrink-0">ğŸ‘¤</div>`;

                          return `
                          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded-lg bg-white hover:bg-gray-50 border-b border-gray-100 transition duration-150 group">
                              
                              <!-- Clickable Area for Profile (Photo + Details) -->
                              <div onclick="navigate('profile', '${child.id}')" class="flex items-center flex-grow min-w-0 cursor-pointer">
                                  ${photoHtml}
                                  <div>
                                      <span class="font-bold text-lg text-gray-800">${child.name}</span>
                                      <span class="text-sm text-gray-500 block sm:inline-block sm:mr-4">(${child.grade})</span>
                                      <span class="text-xs font-mono text-custom-purple block mt-1 sm:mt-0">ID: ${child.id}</span>
                                  </div>
                              </div>

                              <!-- Action Buttons Area -->
                              <div class="flex flex-col sm:flex-row gap-2 mt-2 sm:mt-0 flex-shrink-0">
                                  <button onclick="quickRecordAttendance('${child.id}', 'mass', this)" class="quick-record-btn px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600 transition" data-type="mass">
                                      âœ… Ù‚Ø¯Ø§Ø³
                                  </button>
                                  <button onclick="quickRecordAttendance('${child.id}', 'meeting', this)" class="quick-record-btn px-3 py-1 text-xs font-medium rounded-full bg-indigo-500 text-white hover:bg-indigo-600 transition" data-type="meeting">
                                      âœ… Ø¥Ø¬ØªÙ…Ø§Ø¹
                                  </button>
                                  <button onclick="navigate('profile', '${child.id}')" class="px-3 py-1 text-xs font-medium rounded-full bg-blue-500 text-white hover:bg-blue-600 transition">
                                      ğŸ“‚ ÙØªØ­ Ø§Ù„Ù…Ù„Ù
                                  </button>
                              </div>
                          </div>
                          `;
                     }).join('');
                 }

             } catch (error) {
                 console.error("Error searching children:", error);
                 resultsContainer.innerHTML = '<p class="text-red-600 text-center">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù€ Console.</p>';
             } finally {
                 searchButton.disabled = false;
                 searchButton.innerText = 'Ø¨Ø­Ø«';
             }
        }
        
         /**
          * Quick attendance recording from the list view.
          */
         window.quickRecordAttendance = async function(childId, type, button) {
              if (!khademName) {
                  return showModal('ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø·Ù„ÙˆØ¨Ø©', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø®Ø¯Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.');
              }
              
              // Get the parent container to show the status quickly
              const parentDiv = button.closest('.flex-col');
              
              const originalText = button.innerHTML;
              button.disabled = true;
              button.innerHTML = '...';
              
              try {
                  // Pass the calculated points based on type
                  const points = type === 'mass' ? getPointsSettings().massPoints : getPointsSettings().meetingPoints;
                  await recordAttendance(childId, type, button, points);
                  
                  // Show temporary success feedback in the list item
                  const successMsg = document.createElement('span');
                  successMsg.className = 'text-xs text-green-600 bg-green-100 p-1 rounded';
                  successMsg.innerText = `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${type === 'mass' ? 'Ø§Ù„Ù‚Ø¯Ø§Ø³' : 'Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹'}! (+${points} Ù†Ù‚Ø·Ø©)`;
                  
                  // Find the quick record button again (it might be re-enabled by recordAttendance's finally)
                  const currentBtn = parentDiv.querySelector(`button[data-type="${type}"]`);
                  if(currentBtn) {
                      // Hide the button and show the success message temporarily
                      currentBtn.style.display = 'none';
                      parentDiv.insertBefore(successMsg, currentBtn);

                      setTimeout(() => {
                          successMsg.remove();
                          currentBtn.style.display = 'inline-block';
                          currentBtn.innerHTML = originalText;
                          currentBtn.disabled = false;
                      }, 3000);
                  }

              } catch (error) {
                  // The error handling is mostly inside recordAttendance, just reset button state here
                  button.innerHTML = originalText;
                  button.disabled = false;
              }
         }


        /**
         * Records attendance for mass or meeting for the current date.
         * @param {string} childId 
         * @param {string} type - 'mass' or 'meeting'
         * @param {HTMLElement} button 
         * @param {number} points - Points to award for this action
         */
        window.recordAttendance = async function(childId, type, button, points = 0) {
             if (!khademName) {
                 throw new Error('Khadem not verified.');
             }
             
             const isQuickRecord = button && button.classList.contains('quick-record-btn');

             if (!isQuickRecord) {
                 button.disabled = true;
                 const originalText = button.innerHTML;
                 button.innerHTML = '<div class="animate-spin inline-block w-5 h-5 border-4 border-t-4 border-white border-t-transparent rounded-full mr-2"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
                 button.originalText = originalText; // Store for finally block
             }


             const todayDocId = formatDateToDocId(new Date());
             const attendanceDocRef = doc(db, getAttendanceCollectionPath(childId), todayDocId);
             const childDocRef = doc(db, getChildrenCollectionPath(), childId); // Reference to the main child document

             try {
                 // 1. Check if attendance has already been recorded today
                 const attendanceSnap = await getDoc(attendanceDocRef);
                 const attendanceData = attendanceSnap.data();

                 if (attendanceData && attendanceData[type]) {
                    // Attendance already recorded, show message and exit gracefully
                    if (!isQuickRecord) {
                         showModal('Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${type === 'mass' ? 'Ø§Ù„Ù‚Ø¯Ø§Ø³' : 'Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹'} Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ….`);
                    }
                    return; // EXIT HERE if already recorded
                 }
                 
                 // 2. Prepare data for the attendance record (only if not recorded before)
                 const dataToUpdate = {
                     date: todayDocId,
                     [`${type}`]: true, // mass: true or meeting: true
                     [`${type}Points`]: points, // Record points earned for this event
                     [`${type}Timestamp`]: Date.now(),
                     [`${type}Khadem`]: khademName
                 };

                 // 3. Record the attendance and points for the specific day
                 await setDoc(attendanceDocRef, dataToUpdate, { merge: true });
                 
                 // 4. Update the total points and the specific count on the main child document (only happens ONCE)
                 const countField = type === 'mass' ? 'massTotalCount' : 'meetingTotalCount';

                 await updateDoc(childDocRef, {
                      totalPoints: increment(points), // Use Firestore increment for safety
                      [countField]: increment(1) // NEW: Increment the specific total count
                 });

                 if (!isQuickRecord) {
                     showModal('ØªØ³Ø¬ÙŠÙ„ Ù†Ø§Ø¬Ø­', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${type === 'mass' ? 'Ø§Ù„Ù‚Ø¯Ø§Ø³' : 'Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹'} Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø®Ø§Ø¯Ù…: ${khademName}. (+${points} Ù†Ù‚Ø§Ø·)`);
                 }
             } catch (error) {
                 console.error(`Error recording ${type} attendance:`, error);
                 showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${type === 'mass' ? 'Ø§Ù„Ù‚Ø¯Ø§Ø³' : 'Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹'}.`);
                 throw error;
             } finally {
                 if (!isQuickRecord) {
                     button.disabled = false;
                     button.innerHTML = button.originalText;
                 }
             }
        }

        /**
         * Handles the addition of manual bonus points.
         */
        window.handleBonusPoints = async function(childId, form) {
             const points = parseInt(document.getElementById('bonus-points-input').value, 10);
             const reason = document.getElementById('bonus-reason-input').value.trim();
             const submitButton = form.querySelector('button[type="submit"]');

             if (isNaN(points) || points <= 0) {
                 return showModal('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù…ÙˆØ¬Ø¨ Ù„Ù„Ù†Ù‚Ø§Ø·.');
             }
             if (!reason) {
                 return showModal('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø¨ÙˆÙ†Øµ.');
             }

             submitButton.disabled = true;
             submitButton.innerHTML = '<div class="animate-spin inline-block w-5 h-5 border-4 border-t-4 border-white border-t-transparent rounded-full mr-2"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';

             const todayDocId = formatDateToDocId(new Date());
             const attendanceDocRef = doc(db, getAttendanceCollectionPath(childId), todayDocId);
             const childDocRef = doc(db, getChildrenCollectionPath(), childId);
             
             // Prepare data for the attendance record (merge with existing daily record)
             const dataToUpdate = {
                 date: todayDocId,
                 bonusPoints: increment(points), // Use increment if there's already bonus today
                 bonusReason: reason, 
                 bonusKhadem: khademName,
                 bonusTimestamp: Date.now()
             };

             try {
                  // 1. Record the bonus in the attendance sub-collection
                 await setDoc(attendanceDocRef, dataToUpdate, { merge: true });
                 
                 // 2. Update the total points on the main child document
                 await updateDoc(childDocRef, {
                      totalPoints: increment(points)
                 });
                 
                 showModal('Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨ÙˆÙ†Øµ', `ØªÙ… Ø¥Ø¶Ø§ÙØ© ${points} Ù†Ù‚Ø§Ø· Ø¨ÙˆÙ†Øµ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø®Ø¯ÙˆÙ….`);
                 form.reset(); // Clear the form after successful submission

             } catch (error) {
                 console.error("Error adding bonus points:", error);
                 showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙˆÙ†Øµ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
             } finally {
                 submitButton.disabled = false;
                 submitButton.innerText = 'ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙˆÙ†Øµ';
             }
        }
        
        /**
         * Handles the removal of manual penalty points (the opposite of handleBonusPoints).
         * @param {string} childId 
         * @param {HTMLFormElement} form 
         */
        window.handlePenaltyPoints = async function(childId, form) {
             const points = parseInt(document.getElementById('penalty-points-input').value, 10);
             const reason = document.getElementById('penalty-reason-input').value.trim();
             const submitButton = form.querySelector('button[type="submit"]');

             if (isNaN(points) || points <= 0) {
                 return showModal('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù…ÙˆØ¬Ø¨ Ù„Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø®ØµÙ….');
             }
             if (!reason) {
                 return showModal('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø®ØµÙ….');
             }

             submitButton.disabled = true;
             submitButton.innerHTML = '<div class="animate-spin inline-block w-5 h-5 border-4 border-t-4 border-white border-t-transparent rounded-full mr-2"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø®ØµÙ…...';

             const todayDocId = formatDateToDocId(new Date());
             const attendanceDocRef = doc(db, getAttendanceCollectionPath(childId), todayDocId);
             const childDocRef = doc(db, getChildrenCollectionPath(), childId);
             
             // Prepare data for the attendance record (merge with existing daily record)
             // We use a new field 'penaltyPoints' and decrement the value in the document.
             const dataToUpdate = {
                 date: todayDocId,
                 penaltyPoints: increment(points), // Note: We store the positive value of the penalty
                 penaltyReason: reason, 
                 penaltyKhadem: khademName,
                 penaltyTimestamp: Date.now()
             };

             try {
                  // 1. Record the penalty in the attendance sub-collection
                 await setDoc(attendanceDocRef, dataToUpdate, { merge: true });
                 
                 // 2. Update the total points on the main child document by DECREMENTING
                 await updateDoc(childDocRef, {
                      totalPoints: increment(-points) // Decrement the total points
                 });
                 
                 showModal('Ø®ØµÙ… Ù†Ø§Ø¬Ø­', `ØªÙ… Ø®ØµÙ… ${points} Ù†Ù‚Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ø§Ù„Ù…Ø®Ø¯ÙˆÙ… Ø¨Ø³Ø¨Ø¨: ${reason}.`);
                 form.reset(); // Clear the form after successful submission

             } catch (error) {
                 console.error("Error adding penalty points:", error);
                 showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®ØµÙ…', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
             } finally {
                 submitButton.disabled = false;
                 submitButton.innerText = 'âŒ Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·';
             }
        }


        /**
         * Handles Khadem editing the profile information.
         * @param {string} childId 
         * @param {HTMLFormElement} form 
         */
        window.handleProfileEdit = async function(childId, form) {
            const name = document.getElementById('edit-name').value.trim();
            const grade = document.getElementById('edit-grade').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();
            const parentPhone = document.getElementById('edit-parent-phone').value.trim();
            const address = document.getElementById('edit-address').value.trim();
            const birthdate = document.getElementById('edit-birthdate').value.trim();
            const editPhotoInput = document.getElementById('edit-photo-file');

            const editButton = form.querySelector('button[type="submit"]');
            editButton.disabled = true;
            editButton.innerHTML = '<div class="animate-spin inline-block w-5 h-5 border-4 border-t-4 border-white border-t-transparent rounded-full mr-2"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            let photoBase64 = document.getElementById('profile-child-photo').src; // Default to existing photo

            try {
                // Handle new photo upload/change
                if (editPhotoInput.files.length > 0) {
                    const file = editPhotoInput.files[0];
                    const reader = new FileReader();
                    
                    await new Promise((resolve, reject) => {
                        reader.onload = (e) => {
                            photoBase64 = e.target.result;
                            resolve();
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }
                
                const childDocRef = doc(db, getChildrenCollectionPath(), childId);
                
                await updateDoc(childDocRef, {
                    name,
                    grade,
                    phone,
                    parentPhone,
                    address,
                    birthdate,
                    photoBase64: photoBase64 // Will update photo if changed, otherwise keeps old src
                });

                showModal('Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…: ${name} Ø¨Ù†Ø¬Ø§Ø­.`);
                navigate('profile', childId); // Reload profile view to show changes

            } catch (error) {
                console.error("Error updating child profile:", error);
                showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            } finally {
                editButton.disabled = false;
                editButton.innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
            }
        }


        /**
         * Loads all children data and sets up real-time listener for the Admin Dashboard.
         */
        async function loadAdminDashboardData() {
             const listContainer = document.getElementById('admin-dashboard-list');
             if (!listContainer || !isFirebaseActive) return;

             const childrenColRef = collection(db, getChildrenCollectionPath());
             
             // Use onSnapshot for real-time updates on the list
             // NOTE: This now ONLY reads the main child documents, relying on massTotalCount/meetingTotalCount fields.
             onSnapshot(childrenColRef, (snapshot) => {
                 const allChildren = [];
                 
                 snapshot.forEach(doc => {
                     const data = doc.data();
                     // Use the pre-calculated counts saved in the main document
                     allChildren.push({ 
                         id: doc.id, 
                         ...data,
                         massCount: data.massTotalCount || 0, // NEW: Use the pre-calculated count
                         meetingCount: data.meetingTotalCount || 0 // NEW: Use the pre-calculated count
                     });
                 });

                 if (allChildren.length === 0) {
                      listContainer.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø¯ÙˆÙ…ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯.</td></tr>';
                      return;
                 }
                 
                 // Sort children by Total Points descending
                 allChildren.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));

                 // Render the table rows
                 listContainer.innerHTML = allChildren.map((child, index) => {
                     const photoHtml = child.photoBase64 
                         ? `<img src="${child.photoBase64}" class="w-8 h-8 rounded-full border border-gray-300 object-cover ml-2 inline" alt="ØµÙˆØ±Ø©">`
                         : `<div class="w-8 h-8 rounded-full border border-gray-300 bg-gray-100 ml-2 inline-flex items-center justify-center text-sm">ğŸ‘¤</div>`;

                     const registrationDate = child.createdAt ? formatReadableDate(Date.parse(child.createdAt)) : 'ØºÙŠØ± Ù…ØªØ§Ø­';

                     return `
                         <tr class="hover:bg-gray-50 transition duration-100">
                             <td class="border text-sm font-bold text-gray-600">${index + 1}</td>
                             <td class="border text-right whitespace-nowrap text-gray-800">
                                  <div class="flex items-center justify-end min-w-[150px]">
                                      ${child.name}
                                      ${photoHtml}
                                  </div>
                             </td>
                             <td class="border text-sm text-gray-600">${child.grade}</td>
                             <td class="border text-lg font-extrabold text-custom-purple">${child.totalPoints || 0}</td>
                             <td class="border text-base font-semibold text-green-600">${child.massCount}</td>
                             <td class="border text-base font-semibold text-indigo-600">${child.meetingCount}</td>
                             <td class="border text-xs text-gray-500 whitespace-nowrap">${registrationDate}</td>
                             <td class="border">
                                 <button onclick="navigate('profile', '${child.id}')" class="px-3 py-1 text-xs font-medium rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition">
                                     Ù…Ù„Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                                 </button>
                             </td>
                         </tr>
                     `;
                 }).join('');

             }, (error) => {
                 console.error("Error setting up dashboard listener:", error);
                 listContainer.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-red-500">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>';
             });
        }


        /**
         * Renders the view for searching for a lost code/ID by name.
         */
        function renderFindCodeSearchView(container) {
             // NEW: Added a warning if Firebase is inactive
             const warningHtml = !isFirebaseActive ? `
                 <div class="p-3 mb-4 rounded-lg bg-red-100 border border-red-400 text-red-700 text-sm font-semibold text-center">
                     âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ù†Ø´Ø·. Ù„Ù† ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
                 </div>
             ` : '';

             container.innerHTML = `
                 <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-lg mx-auto">
                     <h2 class="text-2xl font-bold mb-6 text-blue-500 border-b pb-2">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (ID)</h2>
                     ${warningHtml} <!-- Show warning if Firebase is inactive -->
                     <p class="mb-4 text-gray-700">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙˆØ¹Ø±Ø¶Ù‡ ÙƒÙ€ QR Code.</p>
                     <form onsubmit="event.preventDefault(); handleFindCodeSearch()" class="space-y-4">
                         <div>
                             <label for="find-code-name-input" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                             <input type="text" id="find-code-name-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ÙƒÙ…Ø§ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰">
                         </div>
                         <button type="submit" id="find-code-btn" class="w-full primary-btn bg-blue-500 text-white rounded-lg hover:bg-blue-600">Ø¨Ø­Ø« ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ¯</button>
                     </form>
                     
                     <div id="find-code-result" class="mt-6 p-4 border-l-4 border-blue-500 bg-blue-50 rounded-lg hidden text-center">
                          <p class="font-bold text-blue-700 mb-2">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯! ğŸ‰</p>
                          <p class="text-gray-700 mb-4">Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù€ QR Code Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
                          <div id="found-qr-code-area" class="text-center p-4 border-4 border-gray-200 rounded-lg">
                               <!-- QR Code will be generated here -->
                          </div>
                          <p class="mt-4 text-sm text-gray-500">Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.</p>
                          <!-- Copy Link Button -->
                          <button id="copy-found-link-btn" onclick="copyFoundCodeLink()" class="mt-3 w-full primary-btn bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                              ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                          </button>
                      </div>
                      <button onclick="navigate('makhdoum_options')" class="mt-4 w-full text-sm text-gray-600 hover:underline">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®ÙŠØ§Ø±Ø§Øª</button>
                 </div>
             `;
        }

        /**
         * Renders the view for searching and listing children (Admin only).
         */
        function renderChildrenListView(container) {
             // CHECK: Redirect to verification if Khadem name is not set
             if (!khademName) {
                 // Set current page so verification can redirect back here
                 currentPage = 'children_list'; 
                 renderAttendanceVerificationView(container, null);
                 return;
             }
             container.innerHTML = `
                 <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto">
                     <h2 class="text-2xl font-bold mb-6 text-custom-purple border-b pb-2">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø®Ø¯ÙˆÙ… (${khademName})</h2>
                     <p class="mb-4 text-gray-700">Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø¯ÙˆÙ… Ø£Ùˆ Ø¨ÙƒÙˆØ¯Ù‡ (ID) Ù„ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ø¨Ø§Ø´Ø±Ø©.</p>
                     
                     <form onsubmit="event.preventDefault(); handleSearchChildren()" class="space-y-4 mb-6">
                         <div class="flex flex-col sm:flex-row gap-2">
                             <input type="text" id="search-query" required class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø¯ Ø£Ùˆ ÙƒÙˆØ¯Ù‡">
                             <button type="submit" id="search-btn" class="primary-btn bg-green-500 text-white rounded-lg hover:bg-green-600 w-full sm:w-auto px-6">Ø¨Ø­Ø«</button>
                         </div>
                     </form>

                     <div id="search-results" class="space-y-3 max-h-96 overflow-y-auto border p-4 rounded-lg bg-gray-50">
                         <p class="text-gray-500 text-center">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</p>
                     </div>
                 </div>
             `;
        }
        
        /**
         * Toggles the edit form visibility in the profile view.
         * @param {string} childId 
         * @param {Object} data 
         */
        window.toggleEditMode = function(childId, data) {
            const displayDiv = document.getElementById('profile-display-mode');
            const editDiv = document.getElementById('profile-edit-mode');
            const toggleButton = document.getElementById('toggle-edit-btn');
            const isEditing = editDiv.classList.contains('hidden');

            if (isEditing) {
                // Switch to edit mode
                displayDiv.classList.add('hidden');
                editDiv.classList.remove('hidden');
                toggleButton.innerText = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';

                // Fill the form fields with current data
                document.getElementById('edit-name').value = data.name || '';
                document.getElementById('edit-grade').value = data.grade || '';
                document.getElementById('edit-phone').value = data.phone || '';
                document.getElementById('edit-parent-phone').value = data.parentPhone || '';
                document.getElementById('edit-address').value = data.address || '';
                document.getElementById('edit-birthdate').value = data.birthdate || '';

            } else {
                // Switch back to display mode
                displayDiv.classList.remove('hidden');
                editDiv.classList.add('hidden');
                toggleButton.innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…';
            }
        }


        /**
         * Renders the child's profile view for admin attendance tracking.
         */
        function renderProfileView(container, childId) {
             // CHECK: Redirect to verification if Khadem name is not set
             if (!khademName) {
                 renderAttendanceVerificationView(container, childId);
                 return;
             }
             
             if (!childId) {
                 container.innerHTML = '<p class="text-red-600 text-center mt-8">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„ÙˆÙ„Ø¯ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>';
                 return;
             }
             
             if (!isFirebaseActive) {
                 container.innerHTML = `
                      <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto text-center">
                           <h2 class="text-2xl font-bold mb-4 text-red-500">âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</h2>
                           <p class="text-gray-700 mb-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firebase). Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù…Ù„Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.</p>
                           <p class="text-sm text-gray-500">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø¨ÙŠØ¦Ø© Canvas Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
                           <button onclick="navigate('children_list')" class="mt-6 primary-btn bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
                      </div>
                  `;
                  return;
             }
             
             const pointsSettings = getPointsSettings();

             container.innerHTML = `
                  <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto">
                     <!-- Profile Display Mode -->
                     <div id="profile-display-mode">
                          <div class="flex items-start justify-between mb-4 border-b pb-4">
                               <div class="flex items-center space-x-4 space-x-reverse">
                                   <!-- Child Photo Placeholder/Container -->
                                   <img id="profile-child-photo" src="https://placehold.co/60x60/f0f4f8/94a3b8?text=ğŸ‘¤" class="w-16 h-16 rounded-full border-4 border-custom-purple object-cover flex-shrink-0" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…">
                                   <div>
                                       <h2 class="text-2xl font-bold text-custom-purple">Ù…Ù„Ù Ù…ØªØ§Ø¨Ø¹Ø©: <span id="child-name-display" class="text-gray-800">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></h2>
                                       <!-- Display Child ID/Code -->
                                       <p class="text-xs font-mono text-gray-500 mt-1">Ø§Ù„ÙƒÙˆØ¯: <span id="child-id-code" class="font-semibold text-custom-purple">${childId}</span></p>
                                       <p class="text-gray-500">Ø§Ù„ØµÙ/Ø§Ù„Ø®Ø¯Ù…Ø©: <span id="child-grade-display" class="font-semibold">...</span></p>
                                       <p class="text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: <span id="child-birthdate-display" class="font-semibold">...</span></p>
                                       <p class="text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: <span id="child-phone-display" class="font-semibold">...</span></p>
                                       <p class="text-gray-500">Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: <span id="child-parent-phone-display" class="font-semibold">...</span></p>
                                       <p class="text-gray-500">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span id="child-address-display" class="font-semibold">...</span></p>
                                       <!-- Total Points Display -->
                                       <p class="text-lg font-bold mt-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="child-total-points" class="text-green-600">0</span></p>
                                   </div>
                               </div>
                               <!-- Edit Button -->
                               <button id="toggle-edit-btn" onclick="loadChildDataAndToggleEdit('${childId}')" class="px-4 py-2 text-sm font-medium rounded-lg bg-yellow-500 text-white hover:bg-yellow-600 transition">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…</button>
                          </div>
                      </div>

                     <!-- Profile Edit Mode (Hidden by Default) -->
                     <div id="profile-edit-mode" class="hidden">
                         <h3 class="text-xl font-bold mb-4 text-custom-purple">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                         <form onsubmit="event.preventDefault(); handleProfileEdit('${childId}', this)" class="space-y-4 mb-6 p-4 border rounded-lg bg-yellow-50">
                             <div>
                                 <label for="edit-name" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                                 <input type="text" id="edit-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                             </div>
                             <div>
                                 <label for="edit-grade" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØµÙ/Ø§Ù„Ø®Ø¯Ù…Ø©:</label>
                                 <input type="text" id="edit-grade" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                             </div>
                             <div>
                                 <label for="edit-phone" class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                                 <input type="tel" id="edit-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                             </div>
                             <div>
                                <label for="edit-parent-phone" class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</label>
                                <input type="tel" id="edit-parent-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                             </div>
                             <div>
                                <label for="edit-address" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                                <input type="text" id="edit-address" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                             </div>
                             <div>
                                 <label for="edit-birthdate" class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</label>
                                 <input type="date" id="edit-birthdate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple">
                             </div>
                              <div class="border p-4 rounded-lg bg-white">
                                 <label for="edit-photo-file" class="block text-sm font-medium text-gray-700 mb-2">ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø¯ÙˆÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                                 <input type="file" id="edit-photo-file" accept="image/png, image/jpeg" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-custom-purple file:text-white hover:file:bg-purple-700">
                              </div>
                             <button type="submit" class="w-full primary-btn bg-green-500 text-white rounded-lg hover:bg-green-600">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                             <button type="button" onclick="toggleEditMode('${childId}', {})" id="cancel-edit-btn" class="w-full primary-btn bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                         </form>
                     </div>


                       <h3 class="text-xl font-bold mb-4 border-b pb-2">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…: ${formatDateToDocId(new Date())}</h3>
                       
                       <!-- Attendance Status and Record Buttons -->
                       <div id="attendance-status" class="mb-6 p-4 rounded-lg bg-gray-100 grid grid-cols-2 gap-4 text-center">
                           <div>
                               <p class="font-medium text-gray-700">Ø§Ù„Ù‚Ø¯Ø§Ø³ (${pointsSettings.massPoints} Ù†Ù‚Ø·Ø©):</p>
                               <p id="mass-status" class="text-lg font-bold text-red-500">ØºÙŠØ± Ù…Ø³Ø¬Ù„</p>
                               <p id="mass-khadem" class="text-xs text-gray-500 mt-1"></p>
                           </div>
                           <div>
                               <p class="font-medium text-gray-700">Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹ (${pointsSettings.meetingPoints} Ù†Ù‚Ø§Ø·):</p>
                               <p id="meeting-status" class="text-lg font-bold text-red-500">ØºÙŠØ± Ù…Ø³Ø¬Ù„</p>
                               <p id="meeting-khadem" class="text-xs text-gray-500 mt-1"></p>
                           </div>
                       </div>

                       <div class="flex flex-col sm:flex-row gap-4 mb-8">
                          <button onclick="recordAttendance('${childId}', 'mass', this, ${pointsSettings.massPoints})" class="flex-1 primary-btn bg-green-500 text-white rounded-lg hover:bg-green-600" data-type="mass">âœ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù‚Ø¯Ø§Ø³</button>
                          <button onclick="recordAttendance('${childId}', 'meeting', this, ${pointsSettings.meetingPoints})" class="flex-1 primary-btn bg-indigo-500 text-white rounded-lg hover:bg-indigo-600" data-type="meeting">âœ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹</button>
                       </div>

                       <!-- Bonus Points Section -->
                       <h3 class="text-xl font-bold mb-4 border-b pb-2 mt-8 text-blue-600">ğŸ Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ø¨ÙˆÙ†Øµ (Ù…ÙƒØ§ÙØ£Ø©)</h3>
                       <form onsubmit="event.preventDefault(); handleBonusPoints('${childId}', this)" class="space-y-3 p-4 bg-blue-50 rounded-lg">
                           <div>
                               <label for="bonus-points-input" class="block text-sm font-medium text-gray-700 mb-1">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨ÙˆÙ†Øµ (Ù†Ù‚Ø§Ø·):</label>
                               <input type="number" id="bonus-points-input" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ù…Ø«Ø§Ù„: 5 Ø£Ùˆ 10">
                           </div>
                           <div>
                               <label for="bonus-reason-input" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø³Ø¨Ø¨ (Ù…Ù„Ø§Ø­Ø¸Ø§Øª):</label>
                               <input type="text" id="bonus-reason-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ù…Ø«Ø§Ù„: Ø­ÙØ¸ Ø¢ÙŠØ©ØŒ Ø®Ø¯Ù…Ø© Ù…ÙØ§Ø¬Ø¦Ø©ØŒ Ù…Ø³Ø§Ø¨Ù‚Ø©">
                           </div>
                           <button type="submit" class="w-full primary-btn bg-blue-500 text-white rounded-lg hover:bg-blue-600">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙˆÙ†Øµ</button>
                       </form>

                       <!-- NEW: Penalty Points Section -->
                       <h3 class="text-xl font-bold mb-4 border-b pb-2 mt-8 text-penalty">ğŸš« Ø®ØµÙ… Ù†Ù‚Ø§Ø· (Ø¹Ù‚Ø§Ø¨)</h3>
                       <form onsubmit="event.preventDefault(); handlePenaltyPoints('${childId}', this)" class="space-y-3 p-4 bg-penalty rounded-lg border border-red-300">
                           <div>
                               <label for="penalty-points-input" class="block text-sm font-medium text-gray-700 mb-1">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… (Ù†Ù‚Ø§Ø·):</label>
                               <input type="number" id="penalty-points-input" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Ù…Ø«Ø§Ù„: 5 Ø£Ùˆ 10">
                           </div>
                           <div>
                               <label for="penalty-reason-input" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø³Ø¨Ø¨ (Ù…Ù„Ø§Ø­Ø¸Ø§Øª):</label>
                               <input type="text" id="penalty-reason-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Ù…Ø«Ø§Ù„: ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±ØŒ Ø³Ù„ÙˆÙƒ Ø³ÙŠØ¦ØŒ ØªØ£Ø®ÙŠØ± Ù…ØªÙƒØ±Ø±">
                           </div>
                           <button type="submit" class="w-full primary-btn bg-red-600 text-white rounded-lg hover:bg-red-700">âŒ Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·</button>
                       </form>

                       
                       <button onclick="navigate('children_list')" class="mt-8 w-full primary-btn bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø«</button>

                       <h3 class="text-xl font-bold mb-4 border-b pb-2 mt-8">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</h3>
                       <!-- Attendance History will show points earned per day -->
                       <div id="attendance-history" class="space-y-3 max-h-96 overflow-y-auto">
                           <p class="text-gray-500">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>
                       </div>
                   </div>
               `;
             
             // Start fetching data and listening for changes
             loadChildProfileAndAttendance(childId);
        }

        /**
         * Loads child data and sets up edit mode (used by the "ØªØ¹Ø¯ÙŠÙ„" button).
         * @param {string} childId 
         */
        window.loadChildDataAndToggleEdit = async function(childId) {
            const childDocRef = doc(db, getChildrenCollectionPath(), childId);
            try {
                const docSnap = await getDoc(childDocRef);
                if (docSnap.exists()) {
                    toggleEditMode(childId, docSnap.data());
                } else {
                    showModal('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„ÙˆÙ„Ø¯ Ù„ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.');
                }
            } catch (error) {
                console.error("Error fetching child data for edit:", error);
                showModal('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
            }
        }


        /**
         * Loads child details and sets up real-time attendance listener. (Khadem View)
         */
        async function loadChildProfileAndAttendance(childId) {
             const childDocRef = doc(db, getChildrenCollectionPath(), childId);
             try {
                 const childSnap = await getDoc(childDocRef);
                 if (childSnap.exists()) {
                     const data = childSnap.data();
                     document.getElementById('child-name-display').innerText = data.name;
                     document.getElementById('child-grade-display').innerText = data.grade;
                     document.getElementById('child-id-code').innerText = childId; 
                     document.getElementById('child-total-points').innerText = data.totalPoints || 0; // Display total points
                     document.getElementById('child-birthdate-display').innerText = data.birthdate || 'ØºÙŠØ± Ù…ØªØ§Ø­'; 
                     document.getElementById('child-phone-display').innerText = data.phone || 'ØºÙŠØ± Ù…ØªØ§Ø­'; // NEW
                     document.getElementById('child-parent-phone-display').innerText = data.parentPhone || 'ØºÙŠØ± Ù…ØªØ§Ø­'; // NEW
                     document.getElementById('child-address-display').innerText = data.address || 'ØºÙŠØ± Ù…ØªØ§Ø­'; // NEW

                     const photoEl = document.getElementById('profile-child-photo');
                     if (photoEl && data.photoBase64) {
                         photoEl.src = data.photoBase64;
                     } else if (photoEl) {
                         photoEl.src = "https://placehold.co/60x60/f0f4f8/94a3b8?text=ğŸ‘¤";
                     }

                 } else {
                     showModal('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„ÙˆÙ„Ø¯.');
                     navigate('home'); 
                     return;
                 }
             } catch (error) {
                 console.error("Error loading child profile:", error);
                 showModal('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…Ù„Ù Ø§Ù„ÙˆÙ„Ø¯.');
                 return;
             }

             // 2. Setup Real-time Attendance Listener (for daily attendance and history)
             const attendanceCollectionRef = collection(db, getAttendanceCollectionPath(childId));
             
             // Listen to the daily attendance records
             onSnapshot(attendanceCollectionRef, (snapshot) => {
                 const historyContainer = document.getElementById('attendance-history');
                 if (!historyContainer) return; 

                 const todayDocId = formatDateToDocId(new Date());
                 const allAttendance = [];
                 let todayAttendance = null; 
                 
                 snapshot.forEach(doc => {
                     const data = doc.data();
                     allAttendance.push({ id: doc.id, ...data });
                     if (doc.id === todayDocId) {
                         todayAttendance = data;
                     }
                 });

                 // Update Today's Status
                 const pointsSettings = getPointsSettings();
                 if (todayAttendance) {
                     // Mass Status
                     // FIX: Use the points saved in the attendance doc, not the current global settings
                     const massPoints = todayAttendance.massPoints || 0;
                     const meetingPoints = todayAttendance.meetingPoints || 0;

                     const massStatusEl = document.getElementById('mass-status');
                     const massKhademEl = document.getElementById('mass-khadem');
                     massStatusEl.className = todayAttendance.mass ? 'text-lg font-bold text-green-600' : 'text-lg font-bold text-red-500';
                     // FIX: Display the POINTS SAVED in the daily attendance doc
                     massStatusEl.innerText = todayAttendance.mass ? `Ø­Ø¶Ø± (+${massPoints} Ù†Ù‚Ø·Ø©)` : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
                     massKhademEl.innerText = todayAttendance.massKhadem ? `Ø¨ÙˆØ§Ø³Ø·Ø©: ${todayAttendance.massKhadem}` : '';

                     // Meeting Status
                     const meetingStatusEl = document.getElementById('meeting-status');
                     const meetingKhademEl = document.getElementById('meeting-khadem');
                     meetingStatusEl.className = todayAttendance.meeting ? 'text-lg font-bold text-green-600' : 'text-lg font-bold text-red-500';
                     // FIX: Display the POINTS SAVED in the daily attendance doc
                     meetingStatusEl.innerText = todayAttendance.meeting ? `Ø­Ø¶Ø± (+${meetingPoints} Ù†Ù‚Ø§Ø·)` : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
                     meetingKhademEl.innerText = todayAttendance.meetingKhadem ? `Ø¨ÙˆØ§Ø³Ø·Ø©: ${todayAttendance.meetingKhadem}` : '';
                 } else {
                     document.getElementById('mass-status').innerText = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
                     document.getElementById('mass-khadem').innerText = '';
                     document.getElementById('meeting-status').innerText = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
                     document.getElementById('meeting-khadem').innerText = '';
                 }


                 // Render History (Sort by date descending)
                 allAttendance.sort((a, b) => b.id.localeCompare(a.id));

                 if (allAttendance.length === 0) {
                     historyContainer.innerHTML = '<p class="text-gray-500 p-4">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø­Ø¶ÙˆØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
                     return;
                 }

                 historyContainer.innerHTML = allAttendance.map(att => {
                     const dailyTotalPoints = (att.massPoints || 0) + (att.meetingPoints || 0) + (att.bonusPoints || 0) - (att.penaltyPoints || 0);
                     
                     // Display Bonus
                     const bonusInfo = att.bonusPoints ?Â 
                          `<div class="mt-1">
                               <p class="text-xs text-blue-700">ğŸ Ø¨ÙˆÙ†Øµ: +${att.bonusPoints} (${att.bonusReason || 'Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨'})</p>
                               ${att.bonusKhadem ? `<p class="text-xs text-gray-500">Ø¨ÙˆØ§Ø³Ø·Ø©: ${att.bonusKhadem}</p>` : ''}
                           </div>` : '';

                     // NEW: Display Penalty
                     const penaltyInfo = att.penaltyPoints ?Â 
                          `<div class="mt-1">
                               <p class="text-xs text-penalty">â›” Ø®ØµÙ…: -${att.penaltyPoints} (${att.penaltyReason || 'Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨'})</p>
                               ${att.penaltyKhadem ? `<p class="text-xs text-gray-500">Ø¨ÙˆØ§Ø³Ø·Ø©: ${att.penaltyKhadem}</p>` : ''}
                           </div>` : '';

                     const totalPointsHtml = dailyTotalPoints > 0 ? 
                          `<span class="text-lg font-bold text-green-700 mr-4">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…: ${dailyTotalPoints} Ù†Ù‚Ø§Ø·</span>` : 
                          `<span class="text-lg font-bold text-penalty mr-4">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…: ${dailyTotalPoints} Ù†Ù‚Ø§Ø·</span>`;
                    
                     const massKhademDisplay = att.massKhadem ? `<p class="text-xs text-gray-500">Ø§Ù„Ø®Ø§Ø¯Ù…: ${att.massKhadem}</p>` : '';
                     const meetingKhademDisplay = att.meetingKhadem ? `<p class="text-xs text-gray-500">Ø§Ù„Ø®Ø§Ø¯Ù…: ${att.meetingKhadem}</p>` : '';

                     return `
                      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 rounded-lg ${att.id === todayDocId ? 'bg-yellow-100 border-l-4 border-yellow-500' : 'bg-gray-50'}">
                          <span class="font-bold text-gray-800">${att.id}</span>
                          <div class="flex flex-col items-end sm:items-center">
                              ${totalPointsHtml}
                              <div class="flex space-x-3 space-x-reverse flex-wrap items-center mt-1 sm:mt-0">
                                   <div class="flex flex-col items-end">
                                        <span class="text-sm font-medium ${att.mass ? 'text-green-600' : 'text-red-500'}">
                                            Ø§Ù„Ù‚Ø¯Ø§Ø³: ${att.mass ? 'Ø­Ø¶Ø±' : 'ØºØ§Ø¦Ø¨'} (+${att.massPoints || 0})
                                        </span>
                                        ${massKhademDisplay}
                                   </div>
                                   <div class="flex flex-col items-end">
                                        <span class="text-sm font-medium ${att.meeting ? 'text-green-600' : 'text-red-500'}">
                                            Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹: ${att.meeting ? 'Ø­Ø¶Ø±' : 'ØºØ§Ø¦Ø¨'} (+${att.meetingPoints || 0})
                                        </span>
                                        ${meetingKhademDisplay}
                                   </div>
                              </div>
                              ${bonusInfo}
                              ${penaltyInfo}
                          </div>
                      </div>
                      `;
                 }).join('');
             }, (error) => {
                 console.error("Error setting up attendance snapshot listener:", error);
                 showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ.');
             }
             );
             
             // 3. Setup listener for main child doc to update total points immediately
             // NOTE: This listener is CRITICAL for updating totalPoints immediately after incrementing.
             onSnapshot(childDocRef, (docSnap) => {
                 if (docSnap.exists() && document.getElementById('child-total-points')) {
                     document.getElementById('child-total-points').innerText = docSnap.data().totalPoints || 0;
                 }
             }, (error) => {
                 console.error("Error setting up main document snapshot listener:", error);
             });

        }

        /**
         * Renders the search view for children to check their own history.
         */
        function renderHistorySearchView(container) {
             container.innerHTML = `
                 <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-lg mx-auto">
                     <h2 class="text-2xl font-bold mb-6 text-custom-purple border-b pb-2">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ</h2>
                     <p class="mb-4 text-gray-700">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (ID) Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±Ùƒ:</p>
                     <form id="history-search-form" class="space-y-4">
                         <div>
                             <label for="history-id-input" class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙˆØ¯ Ø§Ù„ÙˆÙ„Ø¯ (Child ID):</label>
                             <input type="text" id="history-id-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-custom-purple focus:border-custom-purple" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‡Ù†Ø§">
                         </div>
                         <button type="submit" class="w-full primary-btn bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button>
                     </form>
                 </div>
             `;
             document.getElementById('history-search-form').onsubmit = handleHistorySearch;
        }


        /**
         * Handles history search form submission.
         */
        async function handleHistorySearch(e) {
             e.preventDefault();
             const id = document.getElementById('history-id-input').value.trim();
              if (!isFirebaseActive) {
                 showModal('âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø¨ÙŠØ¦Ø© Canvas.', `
                      <p class="text-xs text-red-500 mb-3">
                          Ù„Ù„ØªØ¬Ø±Ø¨Ø©: ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠ ÙƒÙˆØ¯ØŒ ÙˆÙ„ÙƒÙ† Ù„Ù† ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…Ù„Ù Ø§Ù„ÙˆÙ„Ø¯.
                      </p>
                  `);
                  return;
              }

             if (id) {
                  // Check if the ID is valid
                 const docRef = doc(db, getChildrenCollectionPath(), id);
                 const docSnap = await getDoc(docRef);

                 if (docSnap.exists()) {
                     navigate('child_history', id);
                 } else {
                     showModal('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙÙƒ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ (ID). ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯Ø®Ù„.');
                 }
             }
        }

        /**
         * Renders the full attendance history for the child.
         */
        function renderChildHistoryView(container, childId) {
             if (!childId) {
                 container.innerHTML = '<p class="text-red-600 text-center mt-8">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„ÙˆÙ„Ø¯.</p>';
                 return;
             }
             
             if (!isFirebaseActive) {
                  container.innerHTML = `
                      <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto text-center">
                          <h2 class="text-2xl font-bold mb-4 text-red-500">âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</h2>
                          <p class="text-gray-700 mb-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firebase). Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±.</p>
                          <p class="text-sm text-gray-500">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø¨ÙŠØ¦Ø© Canvas Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©.</p>
                          <button onclick="navigate('history_search')" class="mt-6 primary-btn bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">ğŸ” Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯ Ø¢Ø®Ø±</button>
                      </div>
                  `;
                  return;
             }

              container.innerHTML = `
                 <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto">
                     <div class="flex items-center space-x-4 space-x-reverse mb-6 border-b pb-4">
                          <!-- Child Photo Placeholder/Container -->
                          <img id="history-child-photo" src="https://placehold.co/60x60/f0f4f8/94a3b8?text=ğŸ‘¤" class="w-16 h-16 rounded-full border-4 border-indigo-500 object-cover flex-shrink-0" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…">
                          <div>
                              <h2 class="text-2xl font-bold text-custom-purple">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±ÙŠ</h2>
                              <p class="text-gray-600">Ø§Ù„Ø§Ø³Ù…: <span id="child-history-name" class="font-semibold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></p>
                              <!-- Display Child ID/Code for Makhdoum -->
                              <p class="text-xs font-mono text-gray-500 mt-1">Ø§Ù„ÙƒÙˆØ¯: <span id="child-history-id-code" class="font-semibold text-indigo-500">${childId}</span></p>
                              <!-- Total Points Display for Makhdoum -->
                              <p class="text-lg font-bold mt-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="child-history-total-points" class="text-green-600">0</span></p>
                          </div>
                      </div>

                       <h3 class="text-xl font-bold mb-4">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                       <div id="child-attendance-list" class="space-y-3 max-h-[70vh] overflow-y-auto">
                           <p class="text-gray-500">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>
                       </div>
                       <button onclick="navigate('history_search')" class="mt-6 w-full primary-btn bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">ğŸ” Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯ Ø¢Ø®Ø±</button>
                   </div>
               `;
             
             // Load and listen for data
             loadChildHistory(childId);
        }

        /**
         * Loads child history details and sets up real-time attendance listener for the child view. (Makhdoum View)
         */
        async function loadChildHistory(childId) {
             const childDocRef = doc(db, getChildrenCollectionPath(), childId);
             try {
                 const childSnap = await getDoc(childDocRef);
                 if (childSnap.exists()) {
                     const data = childSnap.data();
                     document.getElementById('child-history-name').innerText = data.name;
                     document.getElementById('child-history-id-code').innerText = childId;
                     document.getElementById('child-history-total-points').innerText = data.totalPoints || 0; // Display total points
                     
                     const photoEl = document.getElementById('history-child-photo');
                     if (photoEl && data.photoBase64) {
                         photoEl.src = data.photoBase64;
                     } else if (photoEl) {
                         photoEl.src = "https://placehold.co/60x60/f0f4f8/94a3b8?text=ğŸ‘¤";
                     }

                 } else {
                     document.getElementById('child-history-name').innerText = 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                     return;
                 }
             } catch (error) {
                 console.error("Error loading child profile:", error);
                 document.getElementById('child-history-name').innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                 return;
             }
             
             // 1. Setup listener for main child doc to update total points immediately
             // NOTE: This listener is CRITICAL for updating totalPoints immediately after incrementing.
             const childHistoryDocRef = doc(db, getChildrenCollectionPath(), childId);
             onSnapshot(childHistoryDocRef, (docSnap) => {
                 if (docSnap.exists() && document.getElementById('child-history-total-points')) {
                     document.getElementById('child-history-total-points').innerText = docSnap.data().totalPoints || 0;
                 }
             }, (error) => {
                 console.error("Error setting up main document snapshot listener (history):", error);
             });


             // 2. Setup Real-time Attendance Listener (for daily attendance and history)
             const attendanceCollectionRef = collection(db, getAttendanceCollectionPath(childId));
             
             onSnapshot(attendanceCollectionRef, (snapshot) => {
                 const listContainer = document.getElementById('child-attendance-list');
                 if (!listContainer) return; // Guard for view change

                 const allAttendance = [];
                 snapshot.forEach(doc => {
                     allAttendance.push({ id: doc.id, ...doc.data() });
                 });

                 // Render History (Sort by date descending)
                 allAttendance.sort((a, b) => b.id.localeCompare(a.id));

                 if (allAttendance.length === 0) {
                     listContainer.innerHTML = '<p class="text-gray-500 p-4">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø­Ø¶ÙˆØ± Ù„Ùƒ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
                     return;
                 }

                 listContainer.innerHTML = allAttendance.map(att => {
                     const massPoints = att.massPoints || 0;
                     const meetingPoints = att.meetingPoints || 0;
                     const bonusPoints = att.bonusPoints || 0;
                     const penaltyPoints = att.penaltyPoints || 0; // NEW: Get penalty points

                     const dailyTotalPoints = massPoints + meetingPoints + bonusPoints - penaltyPoints; // NEW: Calculate total points including penalty

                     // Display Bonus
                     const bonusDisplay = bonusPoints > 0 ? 
                          `<div class="mt-1">
                               <span class="text-xs text-blue-700 bg-blue-100 px-2 py-1 rounded-full mr-2">ğŸ Ø¨ÙˆÙ†Øµ: +${bonusPoints}</span>
                               ${att.bonusKhadem ? `<p class="text-xs text-gray-500 mt-1">Ø¨ÙˆØ§Ø³Ø·Ø©: ${att.bonusKhadem}</p>` : ''}
                           </div>` : '';
                    
                     // NEW: Display Penalty
                     const penaltyDisplay = penaltyPoints > 0 ? 
                          `<div class="mt-1">
                               <span class="text-xs text-penalty bg-red-100 px-2 py-1 rounded-full mr-2">â›” Ø®ØµÙ…: -${penaltyPoints}</span>
                               ${att.penaltyKhadem ? `<p class="text-xs text-gray-500 mt-1">Ø¨ÙˆØ§Ø³Ø·Ø©: ${att.penaltyKhadem}</p>` : ''}
                           </div>` : '';

                     const totalPointsHtml = dailyTotalPoints > 0 ? 
                          `<span class="text-md font-extrabold text-green-700 block sm:inline sm:mr-4">| Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${dailyTotalPoints} Ù†Ù‚Ø·Ø©</span>` :
                          `<span class="text-md font-extrabold text-penalty block sm:inline sm:mr-4">| Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${dailyTotalPoints} Ù†Ù‚Ø·Ø©</span>`;

                     
                     const massKhademDisplay = att.massKhadem ? `<p class="text-xs text-gray-500 mt-1">Ø§Ù„Ø®Ø§Ø¯Ù…: ${att.massKhadem}</p>` : '';
                     const meetingKhademDisplay = att.meetingKhadem ? `<p class="text-xs text-gray-500 mt-1">Ø§Ù„Ø®Ø§Ø¯Ù…: ${att.meetingKhadem}</p>` : '';


                     return `
                      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 rounded-xl bg-blue-50 border-r-4 border-blue-400">
                           <!-- Date and Total Points -->
                           <div class="mb-2 sm:mb-0">
                               <span class="font-bold text-lg text-blue-800">${att.id}</span>
                               ${totalPointsHtml}
                           </div>
                           <div class="flex flex-wrap gap-4 items-center">
                               <!-- Mass Status and Points -->
                               <div class="flex flex-col items-center">
                                   <span class="text-sm font-medium ${att.mass ? 'text-green-600 bg-green-100' : 'text-red-500 bg-red-100'} px-2 py-1 rounded-full">
                                        Ø§Ù„Ù‚Ø¯Ø§Ø³: ${att.mass ? 'âœ… Ø­Ø§Ø¶Ø±' : 'âŒ ØºØ§Ø¦Ø¨'} (+${massPoints})
                                   </span>
                                   ${massKhademDisplay}
                               </div>
                               <!-- Meeting Status and Points -->
                               <div class="flex flex-col items-center">
                                   <span class="text-sm font-medium ${att.meeting ? 'text-green-600 bg-green-100' : 'text-red-500 bg-red-100'} px-2 py-1 rounded-full">
                                        Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹: ${att.meeting ? 'âœ… Ø­Ø§Ø¶Ø±' : 'âŒ ØºØ§Ø¦Ø¨'} (+${meetingPoints})
                                   </span>
                                   ${meetingKhademDisplay}
                               </div>
                               ${bonusDisplay}
                               ${penaltyDisplay} <!-- NEW: Show Penalty info -->
                           </div>
                       </div>
                   `}).join('');

             }, (error) => {
                 console.error("Error setting up history snapshot listener:", error);
                 listContainer.innerHTML = '<p class="text-red-600 p-4">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
             });
        }


        // Initialize the app on load
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('loading').classList.remove('hidden');
             initializeAppAndAuth();
        });

    </script>
</body>
</html>
